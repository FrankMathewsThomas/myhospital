(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{349:function(e,t,s){(function(t){e.exports=angular.module("webconnect.guestSignUp").controller("guestSignUpController",["vcRecaptchaService","$routeParams","$rootScope","$modal","$q","$window","$scope","$http","$rootElement","$location","userService","ConfigurationHolder","$filter","utilityService","localStorageService","downloadStatusService","$translate","confirmBoxService","notificationService","OAuthAccountResponse","signupService","patientPortalAppointmentService","languageFetchService","telecomHelperService",function(e,s,i,n,o,r,a,l,u,d,c,p,g,S,m,F,f,b,O,U,v,y,h,C){(a.minDate=moment(p.dobMinDate,"MM/DD/YYYY").toDate(),a.displayFields={},a.guestSignUpObj={},a.guestSignUpObj.userFields={},a.guestSignUpObj.customFields={},a.errorList={},a.genderList=[],p.serverConfig)?p.serverConfig.availableGenderListPatient.forEach((function(e){a.genderList.push(e.value)})):y.renderWithoutLoginConfigList().then((function(e){p.serverConfig=e.configList,p.serverConfig.availableGenderListPatient.forEach((function(e){a.genderList.push(e.value)}))}));a.guestSignupScreenList=angular.copy(p.serverConfig.guestSignUpScreenFlowSequence.default),a.currentScreen=0,a.maxDate=moment(),a.resendOneTimePasswordForMobile=function(e,t){a.guestSignUpObj.userFields.phoneOTP=null,e.$setPristine(),e.$setUntouched(),a.removeServerErrorFromForm(e,t),a.sendOneTimePasswordForMobile(!0)},a.sendOneTimePasswordForMobile=function(e){return a.guestSignUpObj.userFields.signUpProcess="PHONE",a.guestSignUpObj.source="SELF_SIGN_UP_WEB",v.validateGuestInputDetailsAndSendOTP(a.guestSignUpObj).then((function(t){var s=t.data;if(s.success){var i=s.info[0];if(P(j(i)),i.additionalInfoRequired){var n=p.serverConfig.guestSignUpScreenFlowSequence.default,o=p.serverConfig.guestSignUpScreenFlowSequence.additionalCards;a.guestSignupScreenList=n.concat(o)}else a.guestSignupScreenList=angular.copy(p.serverConfig.guestSignUpScreenFlowSequence.default);e||a.moveToNextScreen()}else{var r=s.info[0];"MOSR64"===r.code||"MOSR65"===r.code?O.error(g("translate")("patientSignUp.optLimitReached")):"SMS404"===r.code?O.error(g("translate")("patientSignUp.otpSendError")):"PLC1"===r.code?O.error(g("translate")("patientSignUp.multiplePatientsFound")):O.error(g("translate")("patientSignUp.otpVerification.somethingWentWrong"))}}),(function(e){O.error(g("translate")("httpErrors."+e.status))}))},a.resendOneTimePasswordForEmail=function(e){a.guestSignUpObj.userFields.emailOTP=null,e.$setPristine(),e.$setUntouched(),a.sendOneTimePasswordForEmail(!0)},a.sendOneTimePasswordForEmail=function(e){return a.guestSignUpObj.userFields.signUpProcess="EMAIL",v.sendOneTimePassword({checkUser:!1,email:a.guestSignUpObj.userFields.email,source:"SELF_SIGN_UP_WEB"}).then((function(e){var t=e.data;t.success?(P(j(t)),resendOTPFlow||a.moveToNextScreen()):"MOSR64"===t.code||"MOSR65"===t.code?O.error(g("translate")("patientSignUp.optLimitReached")):O.error(g("translate")("patientSignUp.otpVerification.somethingWentWrong"))}))},a.validateDateRange=function(e){if(e){a.displayFields.invalidDateRange=!1;var t=moment(e);(t.isBefore(a.minDate)||t.isAfter(a.maxDate))&&(a.displayFields.invalidDateRange=!0)}},a.validateDateOfBirth=function(e){e&&t.trim(e)&&(v.validateDateOfBirth({dob:g("convertDobToUTC")(e)}).success((function(e,t,s,i){a.isBirthdateInvalid="VDOB63"!==e.info[0].code})),a.isBirthdateInvalid=!1)},a.convertDOBToUTC=function(e){return e?g("convertDobToUTC")(e):""},a.setVerifyingMobileNumber=function(e,s,i){s=s&&t.trim(s).length>0&&!s.startsWith("+")?"+"+s:s,e&&(e=s+e,setTimeout((function(){t("#"+i).intlTelInput("setNumber",e)}),0))};var j=function(e){return{isOTPSentOnEmail:e.otpSentOnMail,isOTPSentOnMobile:e.otpSentOnPhone,email:e.email,phoneNumber:e.phoneNumber}},P=function(e){var t=e.isOTPSentOnEmail,s=e.isOTPSentOnMobile,i=e.email,n=e.phoneNumber;t&&s&&i&&i.length>0&&n&&n.length>0?O.success(g("translate")("guestSignUp.otpSuccessMessageBothEmailAndMobile",{emailId:i,phoneNumber:g("formatInternational")(n)})):t&&i&&i.length>0?O.success(g("translate")("guestSignUp.otpSuccessMessageOnlyEmail",{emailId:i})):s&&n&&n.length>0?O.success(g("translate")("guestSignUp.otpSuccessMessageOnlyMobile",{phoneNumber:g("formatInternational")(n)})):a.guestSignUpObj.userFields.phoneNo?O.success(g("translate")("guestSignUp.otpSuccessMessageOnlyMobile",{phoneNumber:(a.guestSignUpObj.userFields.countryCode?a.guestSignUpObj.userFields.countryCode:"")+a.guestSignUpObj.userFields.phoneNo})):O.success(g("translate")("guestSignUp.otpSentSuccessfully"))};function N(e,t){e[t].$setValidity("server",!1)}a.phoneNumberValidation=function(e){var s=t("#"+e);return a.guestSignUpObj.userFields.countryCode=s.intlTelInput("getSelectedCountryData"),a.guestSignUpObj.userFields.phoneNo=s.intlTelInput("getNumber"),a.guestSignUpObj.userFields.countryCode="+"+a.guestSignUpObj.userFields.countryCode.dialCode,a.guestSignUpObj.userFields.phoneNo=a.guestSignUpObj.userFields.phoneNo.replace(a.guestSignUpObj.userFields.countryCode,""),0==C.customPhoneValidator(s)||0==a.guestSignUpObj.userFields.phoneNo.length?a.phoneNumberInvalid=!0:a.phoneNumberInvalid=!1,a.phoneNumberInvalid},a.removeServerErrorFromForm=function(e,t){e[t].$setValidity("server",!0)},a.createPatientForGuestUser=function(e,t){a.guestSignUpObj.userFields.userType="PATIENT",a.guestSignUpObj.userFields.activeResource={status:"ACTIVE"},a.guestSignUpObj.userFields.firstName=a.displayFields.firstName,a.displayFields.middleName&&(a.guestSignUpObj.userFields.firstName+=" "+a.displayFields.middleName),a.guestSignUpObj.customFields.generateCustomPatientId=!0,"PHONE"==a.guestSignUpObj.userFields.signUpProcess?a.guestSignUpObj.userFields.isPhoneNoVerified=!0:"EMAIL"==a.guestSignUpObj.userFields.signUpProcess&&(a.guestSignUpObj.userFields.isEmailVerified=!0),a.guestSignUpObj.userFields.languageOptions=[{firstName:a.displayFields.firstName,lastName:a.guestSignUpObj.userFields.lastName,displayCode:"en",middleName:a.displayFields.middleName}];var s=a.guestSignUpObj,n=v.createCustomHeaderForRequestWithVersion("V2");S.postHTTP(p.baseURL+"/moSignUp/createPatientForGuestUser",s,!0,n).success((function(e){e.success&&1==i.openAuthenticationContainer&&(O.success(g("translate")("patientSignUp.otpVerification.otpVerified")),m.set("x-auth-token",e.token),m.set("ls-patientId",e.patientId),m.set("userType","GUEST"),a.closeCustomModal(),a.$emit("saveAppointmentObj",{}))})).error((function(s){s.errors&&s.errors?(a.errorMap=s.errors[0],e&&t&&N(e,t)):O.error(g("translate")("patientSignUp.otpVerification.somethingWentWrong"))}))},a.moveToNextScreen=function(){var e=a.currentScreen+1;e>=a.guestSignupScreenList.length?a.createPatientForGuestUser():a.currentScreen=e},a.moveToPreviousScreen=function(){a.currentScreen--},a.initialiseAddressObject=function(){a.guestSignUpObj.customFields.address=[],a.guestSignUpObj.customFields.address[0]={},a.guestSignUpObj.customFields.address[0].line=[]},a.extractAddressInfo=function(){var e={url:"SearchTag",value:[]};a.guestSignUpObj.customFields.extension=[],a.displayFields.selectedCountry&&(a.guestSignUpObj.customFields.address[0].country=a.displayFields.selectedCountry.code),a.displayFields.selectedState&&(a.guestSignUpObj.customFields.address[0].state=a.displayFields.selectedState.code),a.displayFields.selectedCity&&(a.guestSignUpObj.customFields.address[0].city=a.displayFields.selectedCity.code),a.displayFields.passportIssueCountry&&a.guestSignUpObj.customFields.passportDetails.passportNo&&(a.guestSignUpObj.customFields.passportDetails.passportIssuingAuthority=a.displayFields.passportIssueCountry.code),a.displayFields.nationality&&e.value.push({patientNationality:a.displayFields.nationality.code}),a.appointmentDetail&&a.appointmentDetail.appointment&&a.appointmentDetail.appointment.location&&a.appointmentDetail.appointment.location.identifier&&(a.guestSignUpObj.locationCode=a.appointmentDetail.appointment.location.identifier),a.appointmentDetail&&a.appointmentDetail.appointment&&a.appointmentDetail.appointment.id&&(a.guestSignUpObj.appointmentId=a.appointmentDetail.appointment.id),a.displayFields.patientRace&&(e.value[0]?e.value[0].race=a.displayFields.patientRace:e.value.push({race:a.displayFields.patientRace})),e.value.length>0&&a.guestSignUpObj.customFields.extension.push(e)},a.validateAgainstMinDate=function(e,s,i){if(e&&t.trim(e))return e<i.startOf("day")},a.concatAddress=function(){a.guestSignUpObj.customFields.address[0].text=v.concatAddressFields(a.guestSignUpObj.customFields.address[0]),a.guestSignUpObj.customFields.address[0].useCode="home"},a.concatAddressHavingCodes=function(){var e={};a.guestSignUpObj.customFields.address[0].line&&(e.line=a.guestSignUpObj.customFields.address[0].line),a.guestSignUpObj.customFields.address[0].postalCode&&(e.postalCode=a.guestSignUpObj.customFields.address[0].postalCode),a.displayFields.selectedCountry&&(e.country=a.displayFields.selectedCountry.name),a.displayFields.selectedState&&(e.state=a.displayFields.selectedState.name),a.displayFields.selectedCity&&(e.city=a.displayFields.selectedCity.name),a.guestSignUpObj.customFields.address[0].text=v.concatAddressFields(e),a.guestSignUpObj.customFields.address[0].useCode="home"},a.validateOtpForMobile=function(e,t,s,i,n){a.disableForm=!0,a.isvalidateOtpForMobileDisable=!0,function(e,t,s){return v.validateOTPForSignUp(e).success((function(e){e&&e.success&&(O.success(g("translate")("patientSignUp.otpVerification.otpVerified")),a.moveToNextScreen())})).error((function(e){e&&0==e.success&&(a.errorMap=e.errors[0],a.isvalidateOtpForMobileDisable=!1),N(t,s)}))}({phoneNumber:e,countryCode:t,otp:s,objectType:"mobile",source:"SELF_SIGN_UP_WEB"},i,n).then((function(e){a.isvalidateOtpForMobileDisable=!1,e.data.success&&(a.guestSignUpObj.userFields.isPhoneNoVerified=!0,a.clearOtpField=!1)}))},a.fetchCountries=function(){var e=v.createCustomHeaderForRequestWithVersion("V1"),t={lang:h.getCurrentLanguage()};S.postHTTP(p.baseURL+"/moCountryDropDown/fetchCountries",t,!1,e).success((function(e){e.success&&(a.countriesList=e.countries)}))},a.fetchStatesWrapper=function(){a.statesList=[],a.citiesList=[];var e={};a.displayFields.selectedCountry&&a.displayFields.selectedCountry.id&&(p.serverConfig&&p.serverConfig.zipcodeRegex?a.zipcodeRegex=p.serverConfig.zipcodeRegex[a.displayFields.selectedCountry.name]:a.configData&&a.configData.zipcodeRegex&&(a.zipcodeRegex=a.configData.zipcodeRegex[a.displayFields.selectedCountry.name]),e.countryId=a.displayFields.selectedCountry.id,function(e){if(!e.countryId)return;var t=v.createCustomHeaderForRequestWithVersion("V1");e.lang=h.getCurrentLanguage(),S.postHTTP(p.baseURL+"/moCountryDropDown/fetchStates",e,!1,t).success((function(e){e.success&&(a.statesList=e.states)}),(function(e){O.error(g("translate")("patientSignUp.serverError"))}))}(e))},a.fetchCitiesWrapper=function(){a.citiesList=[],a.displayFields.selectedCity=null;var e={};a.displayFields.selectedState&&a.displayFields.selectedState.id&&(e.stateId=a.displayFields.selectedState.id,function(e){if(!e.stateId)return;e.lang=h.getCurrentLanguage(),v.fetchCities(e,"V1").then((function(e){e.cities&&e.cities.length>0&&(a.citiesList=e.cities)}),(function(e){O.error(g("translate")("patientSignUp.serverError"))}))}(e))}}])}).call(this,s(1))}}]);