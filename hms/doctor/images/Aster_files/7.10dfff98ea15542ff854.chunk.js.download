(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{142:function(e,t,n){(function(t){function n(e,n,o,a,i,r,s,p,c,l,d,m,u,h,f,S,g,v,b,C,A,D,O,T,y){var I;t("html, body").removeAttr("style"),t("body").removeClass("footerHider"),a.currentDate=new Date,a.appointmentFilterList=["fulfilled","cancelled","arrived","noshow","noShow"],a.appointmentStatusMap={fulfilled:"fulfilled",cancelled:"cancelled",booked:"booked",proposed:"proposed",arrived:"arrived",noshow:"noshow"},a.appointmentDetail={},a.appointmentDetail.appointmentId=e.appointmentId,a.hospitalAppointmentDetails=r.serverConfig.hospitalAppointmentDetails,a.taskCriteria={constraints:{basedOnType:"Appointment",basedOn:a.appointmentDetail.appointmentId,visible:!0,details:!0,requireRequesterDetails:!0,skip:0,count:10}},a.loadMapsconfig=function(){a.googleMapsAPIKey=r.serverConfig.googleMapsAPIKey,a.googleMapsUrl="https://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false&key="+a.googleMapsAPIKey+"&callback=initMap"},g.all([p.configPromise,p.userDetailsPromise].map((function(e){if(e)return e.promise}))).then((function(){a.patientRemarks=r.serverConfig&&r.serverConfig.patientRemarksList&&r.serverConfig.patientRemarksList.length>0?r.serverConfig.patientRemarksList:[]})),a.isGuestUser=!1,m&&m.get("ls-patientId")&&(a.isGuestUser=!0),a.initAppointmentDetails=function(){var t={constraints:{id:a.appointmentDetail.appointmentId,associatedTaskCriteria:{constraints:{status:A.TASK_STATUS_REQUESTED,basedOnType:"Appointment",visible:!0},sendTaskDetails:!0}},includeServiceRequestInfo:!0,includePatientProfile:!0};d.fetchAppointment(t).then((function(t){a.appointmentDetail.appointment=t.appointments[0],a.appointmentDetail.appointment.endDate=i("convertIntoTimeZoneObject")(t.appointments[0].endDate,t.appointments[0].timezone),a.appointmentDetail.appointment.startDate=i("convertIntoTimeZoneObject")(t.appointments[0].startDate,t.appointments[0].timezone),a.appointmentDetail.appointment.timezone=t.appointments[0].timezone,a.appointmentDetail.appointment.type==r.serviceTypes.consultationType||a.appointmentDetail.appointment.type==r.serviceTypes.teleconsultType||a.appointmentDetail.appointment.type==r.serviceTypes.erTeleconsultType?a.isConsultationAppointment=!0:a.isConsultationAppointment=!1,a.appointmentDetail.appointment.currentDate=moment().toDate(),a.appointmentDetail.appointment.location&&a.appointmentDetail.appointment.location.latitude&&a.appointmentDetail.appointment.location.longitude&&(a.appointmentDetail.positionCoordinates=[a.appointmentDetail.appointment.location.latitude,a.appointmentDetail.appointment.location.longitude],a.appointmentDetail.locationUrlLink=a.getDirectionUrl(a.appointmentDetail.appointment.location.latitude,a.appointmentDetail.appointment.location.longitude),I=a.appointmentDetail.appointment.location.identifier),a.appointmentDetail.appointment.patient&&(a.patient=a.appointmentDetail.appointment.patient,p.userDetailsPromise&&a.appointmentDetail.appointment.priceDetail&&a.appointmentDetail.appointment.priceDetail.registrationFees&&p.userDetailsPromise.promise.then((function(){if(!m.get("ls-patientId")){a.patient.registrationFeesPaidLocations&&a.patient.registrationFeesPaidLocations.length>0&&a.patient.registrationFeesPaidLocations.includes(I)}}))),a.appointmentDetail.appointment.practitioner&&(a.practitioner=a.appointmentDetail.appointment.practitioner,a.appointmentDetail.appointment.showAppointmentDetails||(a.appointmentDetail.appointment.showAppointmentDetails={}),a.appointmentDetail.appointment.showAppointmentDetails.speciality=i("practitionerSpeciality")(a.appointmentDetail.appointment.practitioner.practitionerRole));var n=i("newDateFilter")(t.appointments[0].startDate),o=i("newDateFilter")(t.appointments[0].endDate);(a.appointmentDetail.appointmentDuration=o-n,a.appointmentDetail.appointment.initalRemarks=a.appointmentDetail.appointment.remarks?a.appointmentDetail.appointment.remarks:null,a.appointmentDetail.appointment.initialPatientRemarks=a.appointmentDetail.appointment.patientRemarks?a.appointmentDetail.appointment.patientRemarks:[],p.user&&"PATIENT"!=p.user.userType&&"GUEST"!=p.user.userType)&&d.fetchAppointmentHistory({constraints:{id:e.appointmentId}}).then((function(e){a.appointmentDetail.appointment.history=e.appointmentHistory}));(a.appointmentDetail.appointment.priceDetail&&(a.paymentDetails=a.appointmentDetail.appointment.priceDetail),a.appointmentDetail.appointment.showFullRegistrationPopup&&(a.openCustomModal(),p.processTemplatePath="/webconnect/components/appointments/patientPortal/paymentDetailPop.html"),a.appointmentDetail.appointment.location.mapPhotoExists&&(a.appointmentDetail.appointment.location.parentLocationId?a.loadMapPhoto(a.appointmentDetail.appointment.location.parentLocationId):a.loadMapPhoto(a.appointmentDetail.appointment.location.id)),sessionStorage.getItem("appointmentListRedirectionObject"))&&(JSON.parse(sessionStorage.getItem("appointmentListRedirectionObject")).openAddMoreQuestionnaireModal&&a.addMoreQuestionnaires(),sessionStorage.removeItem("appointmentListRedirectionObject"))}))},s.getMap().then((function(e){a.map=e,e.addListener("resize",(function(){var t={lat:a.appointmentDetail.appointment.location.latitude,lng:a.appointmentDetail.appointment.location.longitude};e.setCenter(t)}))})),t(window).resize((function(){a.isPageLoadComplete()&&google.maps.event.trigger(a.map,"resize")})),a.openWindow=function(e){window.open(e)},a.getDirectionUrl=function(e,t){return"https://www.google.com/maps/dir/?api=1&destination="+e+","+t},a.isPageLoadComplete=function(){return!(!a.appointmentDetail||!a.patient)},a.fillQuestionnaireResponse=function(e){e.external?(O.set("externalQuestionnaire.previousRoute",u.url()),u.path("/externalQuestionnairePatResponse/"+e.applicationId)):u.path("/patResponse/"+e.applicationId)},a.viewQuestionnaireResponse=function(e){u.path("/showPatientResponse/"+e.applicationId)},a.noticeInvalidQuestionnaire=function(){v.notice(i("translate")("questionnair.questionnaireResponses.notAllowed"))},a.cancelQuestionnaireResponse=function(e){a.cancelQRId=e;var t=C.openCancelQRModal(a);return t.result.then((function(t){t.status&&a.appointmentDetail.appointment.questionnaires.forEach((function(t,n){t.id===e&&a.appointmentDetail.appointment.questionnaires.splice(n,1)}))})),t.result},a.addMoreQuestionnaires=function(){a.selectedAppointmentId=a.appointmentDetail.appointment.id,u.path("/sendQuestionnaire/"+a.patient.id+"/"+a.selectedAppointmentId)},a.onQuestionnairePreview=function(){sessionStorage.setItem("appointmentListRedirectionObject",JSON.stringify({openAddMoreQuestionnaireModal:!0}))},a.undoTaskCompletion=function(e,t,n,o){S.undoTaskCompletion(e,t,n,o).then((function(e){e.data?(v.success(i("translate")("workflow.taskCenter.editForm.taskCompletionUndone")),b.reload()):e.error&&v.error(i("translate")("workflow.taskCenter.editForm.errorMessages."+e.error))}))},a.updateAppointment=function(e,t,n){a.appointmentDetail.appointment.remarksEditMode=!1,a.appointmentDetail.appointment.patientRemarksEditMode=!1;var o={appointmentId:n,remarks:e,patientRemarks:t};d.updateAppointment(o).then((function(e){e.data?v.success(i("translate")("patientPortal.appointmentDetails.appInfo.remarksUpdatedSuccessfully")):v.error(i("translate")("patientPortal.appointmentDetails.appInfo.errorRemarks"))}))},a.cancelRequestModal=function(e){c.open({templateUrl:"components/appointments/patientPortal/cancelRequest.html",controller:"appointmentModalCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:a.appointmentTabState,remarks:e.remarks,patientRemarks:e.patientRemarks}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.reSchedule=function(e){a.rescheduleEnabled=!0;var t="components/appointments/patientPortal/appointmentSlot-RescheduleBookAgain.html";p.user&&p.user.userType&&("OTHERS"==p.user.userType||"PRACTITIONER"==p.user.userType)&&(t="components/appointments/patientPortal/appointmentSlot-RequestModalCCA.html");c.open({templateUrl:t,controller:"appointmentModalCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:a.appointmentTabState,remarks:e.remarks,patientRemarks:e.patientRemarks,bookAgainEnabled:!1,rescheduleEnabled:!0}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.bookAgain=function(e){a.bookAgainEnabled=!0,a.rescheduleEnabled=!1;c.open({templateUrl:"components/appointments/patientPortal/appointmentSlot-RescheduleBookAgain.html",controller:"appointmentModalCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:"previous",bookAgainEnabled:!0,rescheduleEnabled:!1}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.patientCheckIn=function(e){if("PATIENT"==p.user.userType)d.onCheckinBtnClick(e);else{var t={patientId:e.patient.id,appointmentId:e.id,locationId:e.location.identifier};T.patientCheckIn(t).then((function(e){e.data.checkIn?(v.success(i("translate")("patientPortal.cca.notification.appointmentStatusUpdated")),b.reload()):"futureAppointment"==e.data.reason?v.error(i("translate")("patientPortal.cca.notification.futureDateErrorCheckIn")):v.error(i("translate")("patientPortal.cca.notification.appointmentStatusNotUpdated"))}))}},a.makePaymentNow=function(){if(!a.appointmentDetail.appointment.patient.addressList||a.appointmentDetail.appointment.patient.addressList.length<=0){a.patientId=a.appointmentDetail.appointment.patient.id,a.appointmentId=a.appointmentDetail.appointment.id,a.isPatientAddressUpdated=!1;c.open({templateUrl:"components/appointments/patientPortal/templates/patientAddressInputDetails.html",controller:"patientAddressModalForPaymentCtrl",scope:a,size:"sm",resolve:{}})}else u.path("/payment/initiate/Appointment/"+a.appointmentDetail.appointment.id+"/CONSULTATION")};a.loadMapPhoto=function(e){var t;f.postHTTP(r.baseURL+"/Location/show/"+e).success((function(e,n,o,i){a.location=e,a.photoSrc="data:"+e.map[0].contentType+";base64, "+e.map[0].data;var r=function(e,t){(e=e.replace(/^data:/,"")).match(/image\/[^;]+/);for(var n=e.replace(/^[^,]+,/,""),o=new ArrayBuffer(n.length),a=new Uint8Array(o),i=0;i<n.length;i++)a[i]=n.charCodeAt(i);return new Blob([a],{type:t})}(a.photoSrc,e.map[0].contentType);t=URL.createObjectURL(r);var s=document.createElement("a");s.href=t,s.target="_blank";var p="";o("Content-Disposition")?p=o("Content-Disposition").split(";")[1].split("=")[1]:e.map[0].title&&(p=e.map[0].title),console.log("fileName: "+p),document.body.appendChild(s)}))},a.downloadAppointmentPDF=function(){var e={timeFormat:"hh:mm a",timezone:a.appointmentDetail.appointment.timezone,fileName:"appointment"+a.appointmentDetail.appointment.id+".pdf",appointmentId:a.appointmentDetail.appointment.id,coverageImageType:"THUMBNAIL"};d.downloadAppointmentPDF(e).then((function(e){}))},a.exitAppointmentRemarksEditMode=function(){a.appointmentDetail.appointment.remarksEditMode=!1,a.appointmentDetail.appointment.patientRemarksEditMode=!1,a.appointmentDetail.appointment.remarks!=a.appointmentDetail.appointment.initalRemarks&&(a.appointmentDetail.appointment.remarks=a.appointmentDetail.appointment.initalRemarks),a.appointmentDetail.appointment.patientRemarks!=a.appointmentDetail.appointment.initialPatientRemarks&&(a.appointmentDetail.appointment.patientRemarks=a.appointmentDetail.appointment.initialPatientRemarks)},a.compareToCurrentDate=function(e){if(e)return!(new Date(e)-a.currentDate<0)},a.openInstructionsModal=function(){c.open({templateUrl:"components/appointments/patientPortal/healthcareServiceInstructions.html",controller:"appointmentInstructionsModalCtrl",windowClass:"xs-overlay",scope:a,size:"md"})},a.preValidateTask=function(e,t){var n={basedOn:e.id,basedOnType:"Appointment"};return"cancelRequest"==t?n.reasonCode="cancelAppointment":"rescheduleRequest"==t?n.reasonCode="rescheduleAppointment":"confirmRequest"==t&&(n.reasonCode="confirmAppointment"),D.preValidate(n).then((function(n){"cancelRequest"==t?a.cancelAppointmentRequestModal(e):"rescheduleRequest"==t?a.rescheduleAppointmentRequestModal(e):"confirmRequest"==t&&a.confirmAppointmentRequestModal(e)}),(function(t){if("rescheduleAttemptReachedException"==t.data.errors[0].validationErrors[0].code)a.rescheduleRequestNotifyAdminModal(e);else if("cancelAttemptReachedException"==t.data.errors[0].validationErrors[0].code)a.cancelRequestNotifyAdminModal(e);else{var n=t.data.errors[0].validationErrors;for(var o in n)n.hasOwnProperty(o)&&v.error(i("translate")("patientPortal.appointmentPreValidateTaskError."+n[o].code))}}))},a.rescheduleRequestNotifyAdminModal=function(e){c.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,rescheduleRequestNotifyAdmin:!0}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.cancelRequestNotifyAdminModal=function(e){c.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,cancelRequestNotifyAdmin:!0}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.rescheduleAppointmentRequestModal=function(e){c.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,rescheduleRequest:!0}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.cancelAppointmentRequestModal=function(e){c.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,cancelRequest:!0}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.confirmAppointmentRequestModal=function(e){c.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,confirmRequest:!0}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.redirectToHelpDeskPortal=function(e){u.url("inbox/helpdesk/newQuery?contextType=appointment&contextId="+e.id)},a.executeAppointmentAction=function(e,t){"rescheduleRequest"==t||"cancelRequest"==t?a.preValidateTask(e,t):"rescheduleAppointment"==t?a.reSchedule(e):"cancelAppointment"==t?a.cancelRequestModal(e):"checkIn"==t?a.patientCheckIn(e):"confirmRequest"==t?a.preValidateTask(e,t):"print"==t?a.downloadAppointmentPDF():"submitQuery"==t?a.redirectToHelpDeskPortal(e):"bookAgain"==t?a.bookAgain(e):"payNow"==t?a.makePaymentNow():"noShow"==t?a.noShowAppointment(e):"join"==t?a.redirectToMeeting(e.id):"waitingRoom"==t&&a.redirectToWaitingRoom(e.id)},a.redirectToWaitingRoom=function(e){u.url("/teleConsultationWaitingRoom/"+e)},a.redirectToMeeting=function(e){window.open(r.frontEndURL+"/meeting/start/"+e)},a.noShowAppointment=function(e){var t={appointmentId:e.id};y.noShowAppointment(t).then((function(e){"SC200"==e.data.code?(v.success(i("translate")("patientPortal.cca.notification.noShowAppointmentSuccess")),b.reload()):v.error(i("translate")("patientPortal.cca.notification.noShowAppointmentFailed"))}))},a.openReferenceLinksModal=function(){c.open({templateUrl:"components/appointments/patientPortal/templates/appointmentReferenceLinksModal.html",controller:"appointmentReferenceLinksCtrl",resolve:{returnModalParams:function(){return{appointment:a.appointmentDetail.appointment}}},windowClass:"xs-overlay",scope:a,size:"md"})},a.previewReferenceLink=function(e){window.open(e.url)}}function o(e,t,n,o,a,i,r,s,p){t.selectedAppointment=o.appointment,t.selectedAppointment.selectedReferenceLinksList=[],t.selectedAppointment.referenceLinks&&t.selectedAppointment.referenceLinks.length>0&&(t.selectedAppointment.selectedReferenceLinksList=angular.copy(t.selectedAppointment.referenceLinks)),t.filterReferenceLinks=function(){t.filteredReferenceLinks=[];var e=t.selectedAppointment.healthcareService.referenceLinks,n=t.selectedAppointment.referenceLinks;if(e&&e.length>0)for(var o=0;o<e.length;o++){for(var a=!1,i=0;i<n.length;i++)if(e[o].name.toLowerCase()==n[i].name.toLowerCase()){a=!0;break}a||t.filteredReferenceLinks.push(e[o])}},t.addReferenceLinkToList=function(){t.selectedAppointment.selectedReferenceLinksList.push(t.selectedAppointment.tempReferenceLinkObj),t.showAddMoreBtn=!0,t.selectedAppointment.showReferenceLinkSelection=!1;for(var e=0;e<t.filteredReferenceLinks.length;e++)t.filteredReferenceLinks[e].name.toLowerCase()==t.selectedAppointment.tempReferenceLinkObj.name.toLowerCase()&&t.filteredReferenceLinks.splice(e,1);t.selectedAppointment.tempReferenceLinkObj=void 0},t.showReferenceLinkDropDown=function(){t.showAddMoreBtn=!1,t.selectedAppointment.showReferenceLinkSelection=!0},t.removeLinkedReferenceLink=function(e){e>=0&&(t.filteredReferenceLinks.push(t.selectedAppointment.selectedReferenceLinksList[e]),t.filteredReferenceLinks.sort((function(e,t){var n=e.name.toLowerCase(),o=t.name.toLowerCase();return n<o?-1:n>o?1:0})),t.selectedAppointment.selectedReferenceLinksList.splice(e,1)),0==t.selectedAppointment.selectedReferenceLinksList.length?(t.selectedAppointment.showReferenceLinkSelection=!0,t.showAddMoreBtn=!1):(t.selectedAppointment.showReferenceLinkSelection=!1,t.showAddMoreBtn=!0),t.selectedAppointment.tempReferenceLinkObj=void 0},t.previewReferenceLink=function(e){t.selectedAppointment.selectedReferenceLinksList[e]?window.open(t.selectedAppointment.selectedReferenceLinksList[e].url):window.open(t.selectedAppointment.tempReferenceLinkObj.url)},t.updateAppointment=function(){var o={appointmentId:t.selectedAppointment.id,referenceLinks:t.selectedAppointment.selectedReferenceLinksList};e.updateAppointment(o).then((function(e){e.data?(i.success(r("translate")("patientPortal.appointmentDetails.appInfo.referenceLinkSaveSuccessful")),n.dismiss(),p.reload()):i.error(r("translate")("patientPortal.appointmentDetails.appInfo.referenceLinkSaveError"))}))},t.cancel=function(){t.selectedAppointment.selectedReferenceLinksList=[],t.selectedAppointment.showReferenceLinkSelection=void 0,t.selectedAppointment.tempReferenceLinkObj=void 0,n.dismiss()},t.filterReferenceLinks(),t.selectedAppointment.selectedReferenceLinksList&&t.selectedAppointment.selectedReferenceLinksList.length>0?t.showAddMoreBtn=!0:t.selectedAppointment.showReferenceLinkSelection=!0}o.$inject=["patientPortalAppointmentService","$scope","$uibModalInstance","returnModalParams","$window","notificationService","$filter","$rootScope","$route"],n.$inject=["$routeParams","appointmentService","physicianUserService","$scope","$filter","ConfigurationHolder","NgMap","$rootScope","$modal","userService","patientPortalAppointmentService","localStorageService","$location","$http","utilityService","workflowService","$q","notificationService","$route","questionnaireService","StringConstants","referralService","customLocalStorageService","newAppointmentSystemService","newAppointmentService"],e.exports=angular.module("webconnect.appointments").controller("appointmentDetailCtrl",n),n.$inject=["$routeParams","appointmentService","physicianUserService","$scope","$filter","ConfigurationHolder","NgMap","$rootScope","$modal","userService","patientPortalAppointmentService","localStorageService","$location","$http","utilityService","workflowService","$q","notificationService","$route","questionnaireService","StringConstants","referralService","customLocalStorageService","newAppointmentSystemService","newAppointmentService"],angular.module("webconnect.appointments").controller("appointmentReferenceLinksCtrl",o),o.$inject=["patientPortalAppointmentService","$scope","$uibModalInstance","returnModalParams","$window","notificationService","$filter","$rootScope","$route"]}).call(this,n(1))},37:function(e,t,n){(function(t,n){function o(e,o,a,i,r,s,p,c,l,d,m,u,h,f,S,g,v,b,C){d.search={},d.daysDurationForDisablePastDaySlots=l.serverConfig&&l.serverConfig.daysDurationForDisablePastDaySlots?parseInt(l.serverConfig.daysDurationForDisablePastDaySlots):0,d.firstAvailableSlotDurationCheck=l.serverConfig.firstAvailableSlotDurationCheck,d.disableSlotList=["busy","tentative","busy-tentative","busy-unavailable"],f.openAuthenticationContainer=!1,d.minDate=new Date,d.isDoctorProfileEnabled=!1;s.getUserCookie("user");d.authTokenFound=!1,p.get("x-auth-token")&&(d.authTokenFound=!0),d.search.slotSearchCriteria={count:10,_skip:0},d.search.patientChange=!1,d.search.changeDateAndTime=!1,d.search.consultantGenderList=[],d.search.slotReserved=!1,d.search.appointmentRequested=!1,d.search.checkSlotResourceEmpty=!0,d.isERConsultationAppointment=!1,d.resourceSearchConstraintsMap=[],d.appointmentSlotDuration=3,d.practitionerSearch={skip:0},d.previousDateActive=!1,d.search.appointmentBookingObj={practitionerResource:{},selectedSlotGroup:{},selectedDateGroup:{},slotResource:{},selectedSpecialty:{},locationResource:{},eRhealthcareService:{}},d.search.tentativeScheduleObj={},d.search.tentativeScheduleObj={},d.bookAppointmentDropdown={},d.bookAppointmentDropdown.patientList=[],d.bookAppointmentDropdown.rootPatient=void 0,d.isUserLoggedIn=!0,s.getUserCookie("user")||(d.isUserLoggedIn=!1),s.getUserCookie("user")||(d.isDoctorProfileEnabled=l.serverConfig.isDoctorProfileEnabled),d.searchButtonEnabled=!1,d.selectedResourceSearchConstraintsMap={searchMap:{constraints:{_count:1,_skip:0}}},d.search.selectedHCS="",d.search.searchLocation="",d.selectedDate=moment().toDate(),d.findNextSlots=!0,d.cancel=function(e){e?d.addContainerForPopup(e):d.addContainerForPopup()},d.initAppointmentBooking=function(){d.isSignUpWithFB=p.get("isSignUpWithFB");var e=p.get("login");console.log("saved flag for fb"+p.get("isSignUpWithFB")),d.isSignUpWithFB&&(p.remove("isSignUpWithFB"),p.remove("savedStateOfApplication"),p.remove("saveControllerState"),p.remove("login"),f.openAuthenticationContainer=!0,1==e?(d.openLoginModal=!0,d.addContainerForPopup("fbAccountNotFound")):d.addContainerForPopup("SignUpFlow"))};var A=function(e,t,n,o){t=parseInt(t);var a=new Date(new Date(e.getTime()).setDate(e.getDate()+t));return n&&(a.setHours(0,0,1),a<new Date&&(a=new Date)),o&&a.setHours(23,59,59),a};d.fetchCalenderSlots=function(e){var t;t=e.getDate()==(new Date).getDate()?new Date:new Date(e.setHours(parseInt("00"),parseInt("00"),parseInt("00")));moment(e.setHours(23,59,59)).toDate();d.slotsFrom=moment(t).toDate(),d.slotsTo=A(d.slotsFrom,d.appointmentSlotDuration-1,!1,!0),d.findNextSlots=!0},d.nextPreviousSlotDateForResource=function(e,t,n,o,a,i){if(n&&(d.search.selectedDate=moment(n).toDate()),d.findNextSlots=!0,e||n)if(d.findNextSlots=!0,n){var r=moment().toDate(),s=moment(n).toDate(),p=r;s.setHours(23,59,59),r=p=A(r,d.daysDurationForDisablePastDaySlots,!0,!1);var c=s.getTime()-r.getTime(),l=Math.floor(c/864e5);if(l>=3){var u=Math.floor(l/3);d.slotsFrom=p=d.addSubstractDayFromDate(p,3*u),p.setHours(parseInt("00"),parseInt("00"),parseInt("00")),d.slotsTo=new Date(d.addSubstractDayFromDate(p,d.appointmentSlotDuration-1).setHours(23,59,59))}else d.slotsFrom=d.addSubstractDayFromDate(p,0),d.slotsTo=new Date(d.addSubstractDayFromDate(p,2).setHours(23,59,59));d.slotsFrom<=new Date?d.previousDateActive=!1:d.previousDateActive=!0}else d.slotsFrom=A(d.slotsFrom,d.appointmentSlotDuration,!0,!1),d.slotsTo=A(d.slotsFrom,d.appointmentSlotDuration-1,!1,!0),d.previousDateActive=!0;if(t){d.findNextSlots=!1;r=moment().toDate();if(d.slotsFrom=A(d.slotsFrom,-d.appointmentSlotDuration,!0,!1),d.slotsTo=A(d.slotsTo,-d.appointmentSlotDuration,!1,!0),d.daysDurationForDisablePastDaySlots>0&&(!f.user||"OTHERS"!=f.user.userType&&"PRACTITIONER"!=f.user.userType)){var h=A(moment().toDate(),d.daysDurationForDisablePastDaySlots,!0,!1);d.slotsFrom<=h&&(d.previousDateActive=!1)}else d.slotsFrom<=moment().toDate()&&(d.previousDateActive=!1)}a?(d.search.slotSearchCriteria.fetchSlotsForExtendedDuration=!0,i&&(d.search.slotSearchCriteria.hcsType&&"Specialty"!=d.search.slotSearchCriteria.hcsType?d.search.slotSearchCriteria.healthcareService=i:d.search.slotSearchCriteria.phyID=i)):(d.search.slotSearchCriteria.healthcareService&&delete d.search.slotSearchCriteria.phyID,d.search.slotSearchCriteria.fetchSlotsForExtendedDuration=!1),d.timezone&&(moment(d.slotsFrom).isSame(moment().toDate(),"day")?d.slotsFrom=moment().toDate():d.slotsFrom=m("convertDateObjectIntoStartDateTimezone")(d.slotsFrom,d.timezone),d.slotsTo=m("convertDateObjectIntoEndDateTimezone")(d.slotsTo,d.timezone)),d.search.slotSearchCriteria.slotsFrom=d.slotsFrom,d.search.slotSearchCriteria.slotsTo=d.slotsTo,n&&!o||d.fetchPractitionersOrServicesMappedWithSlots()};var D=function(e){var t={constraints:{_id:e,_count:1,_skip:0,"type:text":C.ER_TELECONSULTATION}};b.fetchHealthcareServiceListFromRouterServiceAbortable(t).then((function(e){var t=e.healthcareServiceList.list[0];t&&(d.search.appointmentBookingObj.eRhealthcareService.id=t.id,d.search.appointmentBookingObj.eRhealthcareService.identifier=t.identifier,d.search.appointmentBookingObj.hcsId=t.id,d.search.appointmentBookingObj.eRhealthcareService.name=t.name,d.calculateAppointmentFees())}))},O=function(){f.userDetailsPromise&&f.userDetailsPromise.promise.then((function(){o.patientId?d.search.loggedInPatientId=o.patientId:s.getUserCookie("user")&&(d.search.loggedInPatientId=s.getUserCookie("user").patientId),d.search.loggedInPatientId&&d.fetchPatient()})),d.closeCustomModal(),d.daysDurationForDisablePastDaySlots>0&&(!f.user||"OTHERS"!=f.user.userType&&"PRACTITIONER"!=f.user.userType)?d.minDate=A(moment().toDate(),d.daysDurationForDisablePastDaySlots,!0,!1):d.minDate=moment().toDate(),d.daysDurationForDisablePastDaySlots>0&&(!f.user||"OTHERS"!=f.user.userType&&"PRACTITIONER"!=f.user.userType)?(d.slotsFrom=A(moment().toDate(),d.daysDurationForDisablePastDaySlots,!0,!1),d.slotsTo=A(d.slotsFrom,d.appointmentSlotDuration-1,!1,!0)):(d.slotsFrom=moment().toDate(),d.slotsTo=A(d.slotsFrom,d.appointmentSlotDuration-1,!1,!0))};d.$watch("search.selectedDate",(function(e,t){r.bindDateInDatePicker(e,d.timezone)})),d.fetchFutureSlots=function(e,t){if(d.daysDurationForDisablePastDaySlots>0&&(!f.user||"OTHERS"!=f.user.userType&&"PRACTITIONER"!=f.user.userType)?d.minDateForSlots=moment().add(parseInt(d.daysDurationForDisablePastDaySlots),"d").startOf("day").toDate():d.minDateForSlots=moment().startOf("day").toDate(),null==e)return"";var n,o;(e=moment(e).add(parseInt(0),"d").startOf("day").toDate())&&(d.search.selectedDate=e,moment(e).isBefore(d.minDateForSlots)?(d.inValidDateSelection=!0,f.showModalSpinner=!1):d.inValidDateSelection=!1,d.inValidDateSelection||(f.showModalSpinner=!0,n=moment(e).isSame(moment().toDate(),"day")?moment().toDate():m("convertDateObjectIntoStartDateTimezone")(e,t),o=m("convertDateObjectIntoEndDateTimezone")(e,t),d.search.tentativeScheduleObj.selectedPractitioner?d.selectedResourceSearchConstraintsMap.searchMap.constraints.id=d.search.tentativeScheduleObj.selectedPractitioner.id:d.search.tentativeScheduleObj.selectedService&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.healthcareService=d.search.tentativeScheduleObj.selectedService.id),d.selectedResourceSearchConstraintsMap.fromDateTime=n,d.selectedResourceSearchConstraintsMap.toDateTime=o,d.selectedResourceSearchConstraintsMap.sendSlotsList=!0,d.selectedResourceSearchConstraintsMap.sendPractitionerDetails=!0,d.selectedResourceSearchConstraintsMap.locationIds=d.search.slotSearchCriteria.location,d.selectedResourceSearchConstraintsMap.patientId=d.search.loggedInPatientId,d.search.appointmentBookingObj.slotResource&&(d.search.appointmentBookingObj.slotResource=void 0),d.fetchFutureDateSlotsOfSelectedResource(n,o)))},d.fetchPatient=function(e){return o.patientId&&(e=o.patientId),e||(e=d.search.loggedInPatientId),i.fetchPatients(e).then((function(e){if(d.search.patients=e.patients,d.bookAppointmentDropdown.patientList=e.patients,d.bookAppointmentDropdown.rootPatient=e.patients?e.patients[0]:void 0,d.patient=e.patients?e.patients[0]:void 0,d.search.selectedPatient=d.patient,p.get("appointmentObj")&&p.get("appointmentObj").patientId&&d.patient.id!=p.get("appointmentObj").patientId)for(var t=0;t<e.patients.length;t++)if(e.patients[t].id==p.get("appointmentObj").patientId){d.patient=e.patients[t],d.search.selectedPatient=d.patient,d.bookAppointmentDropdown.rootPatient=d.patient;break}}))},d.selectPatient=function(e){d.bookAppointmentDropdown.rootPatient=d.bookAppointmentDropdown.patientList[e]},d.fetchCommunicationLangList=function(){d.consultantCommunicationLangConfigList=l.serverConfig.availableCommunicationList,d.search.consultantCommunicationLangList=[],d.search.consultantCommunicationLangList.push("Select"),d.consultantCommunicationLangConfigList.forEach((function(e){d.search.consultantCommunicationLangList.push(e.name)})),d.search.consultantCommunicationLangSelected=d.search.consultantCommunicationLangList[0]},d.communicationLangSelected=function(e){var t=!1;d.consultantCommunicationLangConfigList.forEach((function(n){n.name===e&&(d.search.slotSearchCriteria.comlang=n.value,t=!0)})),t||d.search.slotSearchCriteria.comlang&&delete d.search.slotSearchCriteria.comlang,d.search.searchURLObj&&d.search.searchURLObj.comlang||(d.search.consultantCommunicationLangSelected=d.consultantCommunicationLangConfigList[0]),r.createURLSearchCriteria(d.search.slotSearchCriteria,o.patientId)},d.fetchGenderList=function(){d.consultantGenderConfigList=l.serverConfig.availableGenderListPractitioner,d.search.consultantGenderList.push(m("translate")("records.advanceSearch.genderSelectOption")),d.consultantGenderConfigList.forEach((function(e){d.search.consultantGenderList.push(m("translate")("patientPortal.appointmentSlot.filter."+e.name))})),d.search.searchURLObj&&d.search.searchURLObj.gender||(d.search.consultantGenderSelected=d.search.consultantGenderList[0])},d.genderSelected=function(e){var t=!1;d.consultantGenderConfigList.forEach((function(n){m("translate")("patientPortal.appointmentSlot.filter."+n.name)==e&&(t=!0,d.search.slotSearchCriteria.gender=n.name,d.search.consultantGenderSelected=e)})),!t&&d.search.slotSearchCriteria.gender&&delete d.search.slotSearchCriteria.gender,r.createURLSearchCriteria(d.search.slotSearchCriteria,o.patientId)},d.availableToday=function(e){d.slotsFrom=new Date,d.slotsTo=A(d.slotsFrom,2,!1,!0),d.fetchPractitionersOrServicesMappedWithSlots()},d.hasBookableSlots=function(e){var t=!1;return e.morningSlotsGroup.forEach((function(e){t=t||e.isBookable})),e.noonSlotsGroup.forEach((function(e){t=t||e.isBookable})),e.eveningSlotsGroup.forEach((function(e){t=t||e.isBookable})),t};d.addSubstractDayFromDate=function(e,t){return t=parseInt(t),new Date(new Date(e.getTime()).setDate(e.getDate()+t))},d.fetchFutureDateSlotsOfSelectedResource=function(e,t){d.selectedResourceSearchConstraintsMap.slotType=d.slotType,r.fetchPractitionersOrServicesMappedWithSlots(d.selectedResourceSearchConstraintsMap).then((function(n){d.selectedResource=n.practitionersOrServicesMappedWithSlots.list,d.selectedResource.forEach((function(n,o){var a=[];n.scheduleList.forEach((function(e,t){e.slotsList.forEach((function(e){a.push(e)}))})),n.slotsList=a;var i=a.length;i>0?n.slotsList.forEach((function(o,r){r+1==i&&d.groupSlotsByDateAndTimeForSelectedResource(n,a,e,t)})):d.groupSlotsByDateAndTimeForSelectedResource(n,a,e,t)})),f.showModalSpinner=!1,f.showSpinner=!1}))},d.fetchPractitionersOrServicesMappedWithSlots=function(e){var t;((t=d.search.slotSearchCriteria).phyID?(d.resourceSearchConstraintsMap={searchMap:{constraints:{id:t.phyID,_count:10,_skip:d.practitionerSearch.skip,"_sort:asc":"rank,lowerCaseName.given.value",profilePictureType:"THUMBNAIL",active:!0}}},d.resourceSearchConstraintsMap.hcsType&&(d.resourceSearchConstraintsMap.hcsType=void 0)):(d.resourceSearchConstraintsMap={searchMap:{constraints:{_count:10,_skip:d.practitionerSearch.skip,"_sort:asc":"rank,lowerCaseName.given.value",profilePictureType:"THUMBNAIL",active:!0}}},t.healthcareService&&(d.resourceSearchConstraintsMap.searchMap.constraints.healthcareService=t.healthcareService.join(","),d.resourceSearchConstraintsMap.hcsType=t.hcsType),t.hcsIdentifier&&""!=t.hcsIdentifier&&(d.resourceSearchConstraintsMap.searchMap.constraints.hcsIdentifier=t.hcsIdentifier,d.resourceSearchConstraintsMap.searchMap.constraints.hcsURLId=t.hcsIdentifier,d.resourceSearchConstraintsMap.hcsType=t.hcsType)),d.resourceSearchConstraintsMap.serviceline="CONSULTATION","Select"!=d.search.slotSearchCriteria.gender&&(d.resourceSearchConstraintsMap.searchMap.constraints.gender=d.search.slotSearchCriteria.gender),t.location?d.resourceSearchConstraintsMap.locationIds=t.location:t.locationIdentifier&&(d.resourceSearchConstraintsMap.searchMap.constraints.locationIdentifier=t.locationIdentifier),t.practitionerIdentifier&&(d.resourceSearchConstraintsMap.searchMap.constraints.practitionerIdentifier=t.practitionerIdentifier),t.fetchSlotsForExtendedDuration?(d.resourceSearchConstraintsMap.fetchSlotsForExtendedDuration=t.fetchSlotsForExtendedDuration,d.resourceSearchConstraintsMap.countOfFreeSlots=1,d.resourceSearchConstraintsMap.includeBusySlots=!1):(d.resourceSearchConstraintsMap.includeBusySlots=!0,delete d.resourceSearchConstraintsMap.countOfFreeSlots,delete d.resourceSearchConstraintsMap.fetchSlotsForExtendedDuration),d.resourceSearchConstraintsMap.fromDateTime=moment(d.slotsFrom).format(),d.resourceSearchConstraintsMap.toDateTime=moment(d.slotsTo).format(),d.resourceSearchConstraintsMap.patientId=d.search.loggedInPatientId,null==d.resourceSearchConstraintsMap.patientId&&null!=f.user&&(d.resourceSearchConstraintsMap.patientId=f.user.patientId),d.resourceSearchConstraintsMap.sendSlotsList=!0,d.resourceSearchConstraintsMap.sendPractitionerDetails=!0,d.slotType&&(d.resourceSearchConstraintsMap.slotType=d.slotType),d.resourceSearchConstraintsMap.searchMap.constraints.locationIdentifier&&d.resourceSearchConstraintsMap.searchMap.constraints.practitionerIdentifier||d.resourceSearchConstraintsMap.searchMap.constraints.locationIdentifier&&d.resourceSearchConstraintsMap.searchMap.constraints.hcsURLId||d.resourceSearchConstraintsMap.searchMap.constraints.id||d.resourceSearchConstraintsMap.searchMap.constraints.healthcareService||d.resourceSearchConstraintsMap.locationIds)&&r.fetchPractitionersOrServicesMappedWithSlots(d.resourceSearchConstraintsMap).then((function(t){if(t&&t.practitionersOrServicesMappedWithSlots&&t.practitionersOrServicesMappedWithSlots.list){if(d.resourceSearchConstraintsMap.fetchSlotsForExtendedDuration)for(var n=t.practitionersOrServicesMappedWithSlots.list,o=0;o<d.resultList.length;o++){if(d.resultList[o].practitioner&&n[0].practitioner&&d.resultList[o].practitioner.id==n[0].practitioner.id){d.resultList[o]=n[0];break}if(d.resultList[o].healthcareService&&n[0].healthcareService&&d.resultList[o].healthcareService.id==n[0].healthcareService.id){d.resultList[o]=n[0];break}}else d.resultList=t.practitionersOrServicesMappedWithSlots.list,d.totalCount=t.practitionersOrServicesMappedWithSlots.totalCount;d.statusCode=t.practitionersOrServicesMappedWithSlots.statusCode?t.practitionersOrServicesMappedWithSlots.statusCode:void 0,d.slotsFrom>moment().add("days",l.serverConfig.daysDurationForDisablePastDaySlots).toDate()&&(d.previousDateActive=!0);for(o=0;o<d.resultList.length;o++){var a=d.resultList[o].scheduleList[0]?d.resultList[o].scheduleList[0].timezone:"";if(d.resultList[o].requestStartDateWithTimeZone&&d.resultList[o].requestEndDateWithTimeZone&&d.resultList[o].scheduleList&&d.resultList[o].scheduleList.length>0){d.slotsFrom=m("convertDateStringIntoDateObjectTimeZone")(d.resultList[o].requestStartDateWithTimeZone,a),d.slotsTo=m("convertDateStringIntoDateObjectTimeZone")(d.resultList[o].requestEndDateWithTimeZone,a);break}}d.resultList.forEach((function(t,n){var o=[];t.scheduleList.forEach((function(e,t){e.slotsList.forEach((function(e){o.push(e)}))})),t.slotsList=o;var a=o.length;a>0?o.forEach((function(n,i){i+1==a&&d.groupSlotsByDateAndTime(t,o,!0,e)})):d.groupSlotsByDateAndTime(t,o,!0,e)})),f.showSpinner=!1}else d.totalCount=0}))},d.viewPractitionerProfile=function(e){var t=e.id;l.serverConfig.isDoctorProfileEnabled&&g.getProfile({practitionerId:""+t}).then((function(t){if(t.data.practitioner){var n=t.data.practitioner;h.open({templateUrl:"components/doctorProfile/doctorProfileModal.html",controller:"viewPractitionerProfileCtrl",scope:d,backdrop:"static",resolve:{practitionerProfile:function(){return n},practitioner:function(){return e}},size:"lg"})}else c.info(m("translate")("doctorProfile.view.notAvailable"))}))},d.groupSlotsByDateAndTimeForSelectedResource=function(e,t,n,o){if(e&&e.scheduleList&&e.scheduleList.length>0)var a=e.scheduleList[0].timezone,i=m("convertDateStringIntoDateObjectTimeZone")(e.requestStartDateWithTimeZone,a),r=m("convertDateStringIntoDateObjectTimeZone")(e.requestEndDateWithTimeZone,a);else e&&e.timezone&&(a=e.timezone);d.timezone=a,T(e,i,r,!0),d.search.appointmentBookingObj.selectedDateGroup=e.slotsArray[0]},d.groupSlotsByDateAndTime=function(e,t,n,o){var a,i;e&&e.scheduleList&&e.scheduleList.length>0?(a=e.scheduleList[0]?e.scheduleList[0].timezone:"",i=e.scheduleList[0]&&e.scheduleList[0].slotsList[0]?e.scheduleList[0].slotsList[0].start:e.requestStartDateWithTimeZone):e&&e.timezone&&(a=e.timezone?e.timezone:moment.tz.guess());var r=d.slotsFrom=m("convertDateStringIntoDateObjectTimeZone")(e.requestStartDateWithTimeZone,a),s=d.slotsTo=m("convertDateStringIntoDateObjectTimeZone")(e.requestEndDateWithTimeZone,a);if(d.timezone=a,t.length>0){var p=m("convertDateStringIntoDateObjectTimeZone")(i,a);p.setHours(23,59,59);var c=p.getTime()-r.getTime();if((u=Math.floor(c/864e5))>=3){var l=Math.floor(u/3);e.slotsFrom=r=d.addSubstractDayFromDate(r,3*l),e.slotsTo=s=d.addSubstractDayFromDate(r,d.appointmentSlotDuration-1)}if(c<0)c=-c,u=Math.ceil(c/864e5),l=(l=Math.floor(u/3))<1?1:l,l*=-1,e.slotsFrom=r=A(r,3*l,!0,!1),e.slotsTo=s=A(r,d.appointmentSlotDuration-1,!1,!0)}else{d.daysDurationForFirstAvailableSlot=0;var u=d.daysDurationForFirstAvailableSlot;l=Math.floor(u/3);if(n)e.slotsFrom=r=A(r,3*l,!0,!1),e.slotsTo=s=A(r,d.appointmentSlotDuration-1,!1,!0);else{var h=A(r,3*(l=-1*(l+1)),!0,!1);e.slotsFrom=r=new Date>h?new Date:h,e.slotsTo=s=A(r,d.appointmentSlotDuration-1,!1,!0)}}T(e,r,s)},d.fetchNextOrPreviousRecords=function(e){d.practitionerSearch.skip=e,d.fetchPractitionersOrServicesMappedWithSlots()},d.openAppointmentSlotModal=function(e,t,n,o,a,i){var r,s;r=moment(t.date).isSame(moment().toDate(),"day")?moment().toDate():m("convertDateObjectIntoStartDateTimezone")(t.date,o),s=m("convertDateObjectIntoEndDateTimezone")(t.date,o),d.search.slotSearchCriteria&&d.search.slotSearchCriteria.location?d.selectedResourceSearchConstraintsMap.locationIds=d.search.slotSearchCriteria.location:d.search.slotSearchCriteria.locationIdentifier&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.locationIdentifier=d.search.slotSearchCriteria.locationIdentifier),d.selectedResourceSearchConstraintsMap.fromDateTime=r,d.selectedResourceSearchConstraintsMap.toDateTime=s,d.selectedResourceSearchConstraintsMap.sendSlotsList=!0,d.selectedResourceSearchConstraintsMap.sendPractitionerDetails=!0,d.selectedResourceSearchConstraintsMap.patientId=d.search.loggedInPatientId,d.selectedResourceSearchConstraintsMap.serviceline="CONSULTATION",d.selectedResourceSearchConstraintsMap.includeBusySlots=!0,e.practitioner?(d.selectedResourceSearchConstraintsMap.searchMap.constraints.id=e.practitioner.id,d.search.tentativeScheduleObj.selectedPractitioner=e.practitioner,d.practitioner=e.practitioner,d.search.slotSearchCriteria.healthcareService&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.healthcareService=d.search.slotSearchCriteria.healthcareService.join(","))):e.healthcareService&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.healthcareService=e.healthcareService.id,d.search.tentativeScheduleObj.selectedService=e.healthcareService,e.locationList&&e.locationList.length>0&&(d.search.tentativeScheduleObj.selectedLocation=e.locationList[0]),d.selectedResourceSearchConstraintsMap.hcsType=d.search.slotSearchCriteria.hcsType),d.fetchFutureDateSlotsOfSelectedResource(r,s),d.search.appointmentBookingObj.appointmentComment="",d.search.selectedDate=t.date,d.search.appointmentBookingObj.selectedSlotGroup=n,d.search.appointmentBookingObj.selectedDateGroup=t,d.search.appointmentBookingObj.selectedGroupIndex=i,d.search.appointmentBookingObj.slotGroupString=a,d.changeDateAndTime=!0,d.search.appointmentSlotModalInstance=h.open({templateUrl:"components/appointments/patientPortal/appointmentSlot-slotModal.html",controller:"AppointmentSlotModalCtrl",windowClass:"xs-overlay",scope:d,size:"lg"})},d.openAppointmentSlotModalForWebMobile=function(e,t,n){var o,a;o=moment(t.firstSlotDate).isSame(moment().toDate(),"day")?moment().toDate():m("convertDateObjectIntoStartDateTimezone")(t.firstSlotDate,n),a=m("convertDateObjectIntoEndDateTimezone")(t.firstSlotDate,n),null!=e&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.id=e.id),d.search.slotSearchCriteria&&d.search.slotSearchCriteria.location?d.selectedResourceSearchConstraintsMap.locationIds=d.search.slotSearchCriteria.location:d.search.slotSearchCriteria.locationIdentifier&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.locationIdentifier=d.search.slotSearchCriteria.locationIdentifier),d.search.slotSearchCriteria.healthcareService&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.healthcareService=d.search.slotSearchCriteria.healthcareService.join(",")),d.selectedResourceSearchConstraintsMap.fromDateTime=moment(o).format(),d.selectedResourceSearchConstraintsMap.toDateTime=moment(a).format(),d.selectedResourceSearchConstraintsMap.sendSlotsList=!0,d.selectedResourceSearchConstraintsMap.sendPractitionerDetails=!0,d.selectedResourceSearchConstraintsMap.locationIds=d.search.slotSearchCriteria.location,d.selectedResourceSearchConstraintsMap.patientId=d.search.loggedInPatientId,d.selectedResourceSearchConstraintsMap.serviceline="CONSULTATION",d.selectedResourceSearchConstraintsMap.includeBusySlots=!0,d.fetchFutureDateSlotsOfSelectedResource(o,a),d.search.appointmentBookingObj.appointmentComment="",d.search.selectedDate=t.firstSlotDate,null!=e?(d.search.tentativeScheduleObj.selectedPractitioner=e,d.practitioner=e):t.healthcareService&&(d.selectedResourceSearchConstraintsMap.searchMap.constraints.healthcareService=t.healthcareService.id,d.search.tentativeScheduleObj.selectedService=t.healthcareService,d.selectedResourceSearchConstraintsMap.hcsType=d.search.slotSearchCriteria.hcsType),d.search.appointmentSlotModalInstance=h.open({templateUrl:"components/appointments/patientPortal/appointmentSlot-slotModal.html",controller:"AppointmentSlotModalCtrl",windowClass:"xs-overlay",scope:d,size:"md"})},d.appointmentSlotModalClose=function(){d.search.appointmentSlotModalInstance.close()},d.showCartForAppointmentStatus=function(){"booked"==d.search.appointmentBookingObj.status?(d.search.slotReserved=!0,d.search.appointmentRequested=!0):(d.search.slotReserved=!1,d.search.appointmentRequested=!0)},d.changeDateAndTimeMethod=function(){d.changeDateAndTime=!0;var e={practitioner:d.search.appointmentBookingObj.practitionerResource,healthcareService:d.search.appointmentBookingObj.healthcareServiceResource};d.openAppointmentSlotModal(e,d.search.appointmentBookingObj.selectedDateGroup,d.search.appointmentBookingObj.selectedSlotGroup)},d.changePatient=function(e){if(d.search.patientChange=!0,d.changePatientModalClose(),d.search.appointmentBookingObj.patientId=e,d.patientId=d.search.appointmentBookingObj.patientId,d.doReserveSlot&&d.reserveSlot(),p.get("appointmentObj")){var t=p.get("appointmentObj");t.patientId=e,p.set("appointmentObj",t)}for(var n in d.search.loggedInPatientId=e,d.search.patients)if(d.search.patients.hasOwnProperty(n)&&d.search.patients[n].id==e){d.search.selectedPatient=d.search.patients[n],d.patient=d.search.patients[n];break}d.calculateAppointmentFees()},d.changePatientModalClose=function(){d.changeDateAndTime=!1,d.search.changePatientModalInstance.close()},d.populateChangePatientModal=function(e,t){d.doReserveSlot=e,d.validationCode=t,d.changeDateAndTime=!0,d.search.changePatientList=[],d.search.patients.length>1&&d.search.patients.forEach((function(e){if(e.id!=d.search.appointmentBookingObj.patientId){var t=!0;d.search.changePatientList.forEach((function(n){n.id==e.id&&(t=!1)})),1==t&&d.search.changePatientList.push(e),e.identifier.forEach((function(t){"patientId"==t.type.text&&(e.patientMRN=t.value)}))}})),d.search.changePatientModalInstance=h.open({templateUrl:"components/appointments/patientPortal/changePatient--modal.html",controller:"AppointmentSlotModalCtrl",windowClass:"xs-overlay",scope:d,size:"sm"})},d.populateSelectedSlot=function(e,t){d.search.tentativeScheduleObj.slotResource=e.slot,d.search.tentativeScheduleObj.slotStartDate=e.start,d.search.checkSlotResourceEmpty=!1,d.search.tentativeScheduleObj.locationResource=t.location,d.search.tentativeScheduleObj.healthcareService=t.healthcareService,d.search.appointmentBookingObj.paymentModes=t.paymentModes,d.search.appointmentBookingObj.locationIdentifier=t.locationIdentifier,d.search.appointmentBookingObj.timezone=t.timezone,d.search.appointmentBookingObj.scheduleId=t.scheduleId,t.priceDetail&&!r.isEmpty(t.priceDetail)?d.search.appointmentBookingObj.practitionerFees=t.priceDetail:d.search.appointmentBookingObj.practitionerFees=void 0,d.search.appointmentBookingObj.appointmentComment&&(d.search.appointmentBookingObj.appointmentComment=void 0)},d.getDataForRFA=function(e,t,n){d.search.tentativeScheduleObj.locationResource=e.location,d.search.appointmentBookingObj.hcsId=e.healthcareService,d.search.tentativeScheduleObj.startDate=t,d.search.tentativeScheduleObj.endDate=n,d.search.tentativeScheduleObj.appointmentDate=t,d.search.appointmentBookingObj.paymentModes=e.paymentModes,d.search.appointmentBookingObj.timezone=e.timezone,d.search.appointmentBookingObj.locationIdentifier=e.locationIdentifier,d.search.appointmentBookingObj.scheduleId=e.scheduleId,e.priceDetail&&!r.isEmpty(e.priceDetail)?d.search.appointmentBookingObj.practitionerFees=e.priceDetail:d.search.appointmentBookingObj.practitionerFees=void 0,e.slotExtension&&e.slotExtension.forEach((function(e){"SearchTag"==e.url&&(d.search.appointmentBookingObj.slotExtensionValue=e.value[0])})),d.search.tentativeScheduleObj.slotResource&&(d.search.tentativeScheduleObj.slotResource=void 0)},d.calculateAppointmentFees=function(){f.configPromise.promise.then((function(){if(1!=l.serverConfig.paymentGatewayConfig.paymentGatewayEnabledForAppointment||!d.search.appointmentBookingObj.practitionerFees&&1!=d.isERConsultationAppointment)s.setUserCookie("appointmentObj",d.search.appointmentBookingObj);else{var e={locationId:d.search.appointmentBookingObj.locationIdentifier?d.search.appointmentBookingObj.locationIdentifier:"",patientId:d.search.selectedPatient.id,fromDateTime:d.slotsTo?d.slotsTo:null,slotType:d.slotType?d.slotType:null,serviceline:"CONSULTATION"};if(d.search.tentativeScheduleObj.selectedPractitioner&&(e.practitionerId=d.search.tentativeScheduleObj.selectedPractitioner.practitionerIdentifiers),d.search&&d.search.tentativeScheduleObj&&d.search.tentativeScheduleObj.selectedService&&d.search.tentativeScheduleObj.selectedService.identifier&&(e.healthcareServiceId=d.search.tentativeScheduleObj.selectedService.identifier),d.isERConsultationAppointment&&d.search.appointmentBookingObj&&d.search.appointmentBookingObj.eRhealthcareService&&d.search.appointmentBookingObj.eRhealthcareService.identifier){var t=[];d.search.appointmentBookingObj.eRhealthcareService.identifier.forEach((function(e){t.push(e.value)})),e.healthcareServiceId=t.join(",")}r.calculateAppointmentFees(e).then((function(e){e.appointmentFeesInfo?(d.search.appointmentBookingObj.doctorFees=Number(e.appointmentFeesInfo.doctorFees),d.search.appointmentBookingObj.serviceFees=Number(e.appointmentFeesInfo.serviceFees),d.search.appointmentBookingObj.appointmentFees=Number(e.appointmentFeesInfo.totalAppointmentFees),d.search.appointmentBookingObj.registrationFees=Number(e.appointmentFeesInfo.registrationFees),d.search.appointmentBookingObj.taxAmount=Number(e.appointmentFeesInfo.taxAmount),d.search.appointmentBookingObj.discount=Number(e.appointmentFeesInfo.discount),d.search.appointmentBookingObj.appointmentFeesInfoId=e.appointmentFeesInfo.resourceId,d.search.appointmentBookingObj.currency=e.appointmentFeesInfo.currency,s.setUserCookie("appointmentObj",d.search.appointmentBookingObj)):d.isERConsultationAppointment?c.error(m("translate")("patientPortal.appointmentSlot.payment.priceMasterNotConfigured")):c.error(m("translate")("patientPortal.appointmentSlot.payment.slotNotFree"))}))}f.configPromise&&1==l.serverConfig.isReserveSlotEnabled&&"booked"==d.search.appointmentBookingObj.status&&d.slotTimer(),d.showCartForAppointmentStatus()}))},d.getPatientForAppointmentObject=function(){p.get("ls-patientId")?d.search.appointmentBookingObj.patientId=p.get("ls-patientId"):d.search.appointmentBookingObj.patientId=d.search.loggedInPatientId?d.search.loggedInPatientId:s.getUserCookie("user").patientId,d.patientId=d.search.appointmentBookingObj.patientId,d.search.loggedInPatientId=d.search.appointmentBookingObj.patientId,d.search.patients||(d.fetchPatientPromise=d.fetchPatient(),d.fetchPatientPromise.then((function(){for(var e in d.search.patients)if(d.search.patients.hasOwnProperty(e)&&d.search.patients[e].id==d.search.appointmentBookingObj.patientId){d.search.selectedPatient=d.search.patients[e],d.patient=d.search.patients[e];break}}))),"proposed"!=d.search.appointmentBookingObj.status&&0!=l.serverConfig.isReserveSlotEnabled||d.findMRNBasedOnLogin()},d.makeAppointmentBookingObj=function(){d.search.appointmentBookingObj.patientId&&(d.search.appointmentBookingObj.patientId=void 0),1==r.isEmpty(d.search.tentativeScheduleObj.slotResource)?d.search.appointmentBookingObj.status="proposed":(d.search.appointmentBookingObj.status="booked",d.search.tentativeScheduleObj.appointmentDate=d.search.tentativeScheduleObj.slotResource.start.value),d.search.appointmentBookingObj.appointmentType=k()},d.reserveSlot=function(){1==d.search.slotReserved&&(d.search.slotReserved=!1);var e={status:"busy-tentative",slotResourceList:[d.search.tentativeScheduleObj.slotResource],serviceline:"CONSULTATION",appointmentType:k()};d.search.tentativeScheduleObj.selectedPractitioner?e.practitionerId=d.search.tentativeScheduleObj.selectedPractitioner.id:e.healthcareServiceId=d.search.tentativeScheduleObj.selectedService.id,d.search.appointmentBookingObj.patientId||d.getPatientForAppointmentObject(),e.patientId=d.search.appointmentBookingObj.patientId,r.reserveSlot(e).then((function(e){e.data&&e.data.info?"AESDD1"===e.data.info[0].code?d.user&&"GUEST"!=d.user.userType&&d.search.patients&&d.search.patients.length>1?d.populateChangePatientModal(!0,"AESDD1"):c.error(m("translate")("phlebotomy.appointment.errorMessages.appointmentExistsSameDayForDoctor")):"AESDS1"===e.data.info[0].code?d.user&&"GUEST"!=d.user.userType&&d.search.patients.length>1?d.populateChangePatientModal(!0,"AESDS1"):c.error(m("translate")("phlebotomy.appointment.errorMessages.appointmentExistsSameDayForSlot")):"SLTNC1"==e.data.info[0].code?c.error(m("translate")("phlebotomy.appointment.errorMessages.slotNotCreated")):"SLTE1"==e.data.info[0].code?c.error(m("translate")("phlebotomy.appointment.errorMessages.slotNotFree")):"SLCSU1"==e.data.info[0].code?(d.search.slotReserved=e.data.status,d.search.appointmentBookingObj.slotResource.freeBusyType="busy-tentative",d.search.appointmentBookingObj.slotResource=e.data.info[0].slotSaved&&e.data.info[0].slotSaved.length>0?e.data.info[0].slotSaved[0]:d.search.tentativeScheduleObj.slotResource,d.findMRNBasedOnLogin()):(c.error(m("translate")("patientPortal.appointmentSlot.payment.slotNotFree")),d.fetchPatientPromise.then((function(){p.get("ls-patientId")&&s.removeAllCookies(!0)}))):c.error(m("translate")("patientPortal.appointmentSlot.payment.slotNotFree"))}))},d.payOnline=function(){d.saveAppointment("online")},d.payOnSite=function(){d.saveAppointment("onsite")},d.payByInsurance=function(e){d.saveAppointment("insurance",e)},d.saveAppointment=function(e,t){v.raiseEvent({name:"APPOINTMENT_BOOKING",data:{paymentType:e}}),d.search.appointmentObj={status:d.search.appointmentBookingObj.status,appointmentType:k(),locationId:d.search.appointmentBookingObj.locationIdentifier,hcsId:d.search.appointmentBookingObj.hcsId,paymentType:e||null,patientId:d.search.appointmentBookingObj.patientId,appointmentFeesInfoId:d.search.appointmentBookingObj.appointmentFeesInfoId,bookingReason:d.search.appointmentBookingObj.bookingReason,serviceline:"CONSULTATION"},null!=t&&(d.search.appointmentObj.coverageId=t,f.showModalSpinner=!0),"proposed"==d.search.appointmentObj.status?(d.search.appointmentObj.hcsId=d.search.appointmentBookingObj.hcsId,d.search.appointmentObj.startDate=d.search.appointmentBookingObj.startDate,d.search.appointmentObj.endDate=d.search.appointmentBookingObj.endDate,d.search.appointmentObj.appointmentComment=d.search.appointmentBookingObj.appointmentComment,d.search.appointmentObj.timezone=d.search.appointmentBookingObj.timezone,d.search.appointmentObj.slotExtensionValue=d.search.appointmentBookingObj.slotExtensionValue,d.search.appointmentObj.scheduleId=d.search.appointmentBookingObj.scheduleId):"booked"==d.search.appointmentObj.status&&(d.search.appointmentObj.slotResourceList=[d.search.appointmentBookingObj.slotResource],d.search.appointmentObj.scheduleId=d.search.appointmentBookingObj.scheduleId),d.search.appointmentBookingObj.practitionerResource&&(d.search.appointmentObj.practitionerId=d.search.appointmentBookingObj.practitionerResource.id),r.saveAppointment(d.search.appointmentObj).then((function(t){if(d.search.appointmentObj.coverageId&&(f.showModalSpinner=!1),t.data.appointmentResource){p.get("appointmentObj")&&p.remove("appointmentObj"),1==d.changeDateAndTime&&(d.changeDateAndTime=!1),d.search.savedAppointmentObj=t.data.appointmentResource,d.isPatientAddressUpdated=!0;var n=d.search.savedAppointmentObj.serviceType[0].text;if((!d.patient||d.patient.address.length<=0)&&!d.isERConsultationAppointment){d.patientId=d.patient.id,d.paymentType=e,d.isPatientAddressUpdated=!1;h.open({templateUrl:"components/appointments/patientPortal/templates/patientAddressInputDetails.html",controller:"patientAddressUpdateModalCtrl",scope:d,size:"sm",resolve:{}})}if(d.isPatientAddressUpdated)if(l.serverConfig.paymentGatewayConfig.paymentGatewayEnabledForAppointment&&(d.search.appointmentBookingObj.practitionerFees||d.search.appointmentBookingObj.serviceFees))if("online"==e)u.path("/payment/initiate/Appointment/"+d.search.savedAppointmentObj.id+"/CONSULTATION"),t.data&&t.data.code&&"423"==t.data.code&&(c.error(m("translate")("Some thing went Wrong, please contact the system Admin")),u.path("/appointment/details/"+d.search.savedAppointmentObj.id));else d.search.payOnSiteObj={serviceline:"CONSULTATION",resourceId:d.search.savedAppointmentObj.id,paymentContext:"Appointment",paymentDetailSource:"PaymentDetailFromAppointment",paymentMethod:e},r.payOnSite(d.search.payOnSiteObj).then((function(e){C.ER_TELECONSULTATION==n?u.path("/teleConsultationWaitingRoom/"+d.search.savedAppointmentObj.id):u.path("/appointment/details/"+d.search.savedAppointmentObj.id)}));else"VIRTUAL_MEETING"==n||"MEETING"==n?u.path("/meetingDetails/"+d.search.savedAppointmentObj.id):n==C.ER_TELECONSULTATION?u.path("/teleConsultationWaitingRoom/"+d.search.savedAppointmentObj.id):u.path("/appointment/details/"+d.search.savedAppointmentObj.id);else c.error(m("translate")("PatientProfileNew.registration.notification.patientUpdateNotification"))}else if(t.data.info&&"AESDD1"===t.data.info[0].code)d.user&&"GUEST"!=d.user.userType&&d.search.patients.length>1&&1!=d.isERConsultationAppointment?d.populateChangePatientModal(!0,"AESDD1"):c.error(m("translate")("phlebotomy.appointment.errorMessages.appointmentExistsSameDayForDoctor"));else if(t.data.info&&"AESDS1"===t.data.info[0].code)d.user&&"GUEST"!=d.user.userType&&d.search.patients.length>1?d.populateChangePatientModal(!0,"AESDS1"):c.error(m("translate")("phlebotomy.appointment.errorMessages.appointmentExistsSameDayForSlot"));else if(null!=t.data.errors&&null!=t.data.errors&&null!=t.data.errors[0].validationErrors[0].code&&(t.data.errors[0].validationErrors[0].code.indexOf("CASR")||t.data.errors[0].validationErrors[0].code.indexOf("CESR"))){var o=t.data.errors[0].validationErrors[0].code;f.$broadcast("show_coverage_listing",{patientId:d.patientId,code:o})}else c.error(m("translate")("patientPortal.appointmentSlot.payment.slotNotApplicable"))}))},d.openAuthenticationContainerPopup=function(){var e=p.get("x-auth-token");null==e||null==e?d.openCustomModal():p.get("ls-patientId")&&s.removeAllCookies(!0)},d.closeAuthenticationContainerPopup=function(){f.processTemplatePath="components/login/authModal.html",d.closeCustomModal(),p.get("appointmentObj")&&p.remove("appointmentObj")},d.backButtonAuthenticationPopup=function(){f.processTemplatePath="components/login/authModal.html"},d.findMRNBasedOnLogin=function(){d.search.patients&&d.search.patients.length>0?d.calculateAppointmentFees():d.fetchPatientPromise.then((function(){d.calculateAppointmentFees()}))},d.fillAndValidateQuestionnaire=function(e){d.filledQuestionnaireList||(d.filledQuestionnaireList=[]),d.questionnaireIdsList=e,d.loggedInPatientId=d.search.loggedInPatientId;var n=h.open({templateUrl:"components/questionBuilder/questionnaireAppointmentModal/questionnaireAppointmentModal.html",controller:"questionnaireAppointmentModalCtrl",size:"md",scope:d,windowClass:"show"});return navigator.userAgent.match(/iPhone|iPad|iPod/i)&&n.opened.then((function(){setTimeout((function(){t("select").click((function(){t("body").hasClass("modal-open")&&window.scrollTo(0,0)}))}))})),n.result};function T(e,t,n,o){var a=0;for(e.slotsArray=[];n>=t;)e.slotsArray[a]={date:t,slots:[],morningSlotsGroup:[],noonSlotsGroup:[],eveningSlotsGroup:[],morningSlotsFound:!1,noonSlotsFound:!1,eveningSlotsFound:!1},e.scheduleList.forEach((function(n,o){var i="",r="",s="";n.location&&(n.location.address&&n.location.address[0]&&(i=n.location.address[0].translatedText?n.location.address[0].translatedText:m("formatAddressObj")(n.location.address[0])),d.slotType===C.TELECONSULTATION?(r=m("translate")("searchAppointment."+C.TELECONSULTATION),i=m("translate")("searchAppointment."+C.TELECONSULTATION)):r=n.location.name,s=n.location.identifier[0].value),e.slotsArray[a].morningSlotsGroup.push({morningSlots:[],timezone:n.timezone,location:i,locationName:r,locationIdentifier:s,paymentModes:n.paymentModes,isBookable:n.isBookable,priceDetail:n.priceDetail,healthcareService:n.healthcareService,scheduleId:n.scheduleId}),e.slotsArray[a].noonSlotsGroup.push({noonSlots:[],timezone:n.timezone,location:i,locationName:r,locationIdentifier:s,paymentModes:n.paymentModes,isBookable:n.isBookable,priceDetail:n.priceDetail,healthcareService:n.healthcareService,scheduleId:n.scheduleId}),e.slotsArray[a].eveningSlotsGroup.push({eveningSlots:[],timezone:n.timezone,location:i,locationName:r,locationIdentifier:s,paymentModes:n.paymentModes,isBookable:n.isBookable,priceDetail:n.priceDetail,healthcareService:n.healthcareService,scheduleId:n.scheduleId}),e.healthcareService?I(e,n,t,a):y(e,n,t,a,o)})),t=d.addSubstractDayFromDate(t,1),a++}function y(e,t,n,o,a){t.slotsList.forEach((function(t){var i=m("convertDateStringIntoDateObjectTimeZone")(t.start,d.timezone);if(i.getDate()==n.getDate()&&(e.slotsArray[o].slots.push(t),3==d.appointmentSlotDuration)){var r=m("date")(i,"H");r<12?(e.slotsArray[o].morningSlotsGroup[a].morningSlots.push(t),e.slotsArray[o].morningSlotsFound=!0):r<17?(e.slotsArray[o].noonSlotsGroup[a].noonSlots.push(t),e.slotsArray[o].noonSlotsFound=!0):(e.slotsArray[o].eveningSlotsGroup[a].eveningSlots.push(t),e.slotsArray[o].eveningSlotsFound=!0)}})),e.slotsArray&&e.slotsArray.length>0&&e.slotsArray.forEach((function(e){e.morningSlotsGroup&&e.morningSlotsGroup.length>1&&e.morningSlotsGroup.sort((function(e,t){if(e.morningSlots&&e.morningSlots.length>0&&e.morningSlots[0].start&&t.morningSlots&&t.morningSlots.length>0&&t.morningSlots[0].start)return e.morningSlots[0].start>t.morningSlots[0].start})),e.noonSlotsGroup&&e.noonSlotsGroup.length>1&&e.noonSlotsGroup.sort((function(e,t){if(e.noonSlots&&e.noonSlots.length>0&&e.noonSlots[0].start&&t.noonSlots&&t.noonSlots.length>0&&t.noonSlots[0].start)return e.noonSlots[0].start>t.noonSlots[0].start})),e.eveningSlotsGroup&&e.eveningSlotsGroup.length>1&&e.eveningSlotsGroup.sort((function(e,t){if(e.eveningSlots&&e.eveningSlots.length>0&&e.eveningSlots[0].start&&t.eveningSlots&&t.eveningSlots.length>0&&t.eveningSlots[0].start)return e.eveningSlots[0].start>t.eveningSlots[0].start}))}))}function I(e,t,n,o){t.slotsList.forEach((function(a){var i=m("convertDateStringIntoDateObjectTimeZone")(a.start,d.timezone);if(i.getDate()==n.getDate()&&(e.slotsArray[o].slots.push(a),3==d.appointmentSlotDuration)){var r=m("date")(i,"H");if(r<12)(s=e.slotsArray[o].morningSlotsGroup)[0].isBookable==t.isBookable?s[0].morningSlots.push(a):s[1].morningSlots.push(a),e.slotsArray[o].morningSlotsFound=!0;else if(r<17){(s=e.slotsArray[o].noonSlotsGroup)[0].isBookable==t.isBookable?s[0].noonSlots.push(a):s[1].noonSlots.push(a),e.slotsArray[o].noonSlotsFound=!0}else{var s;(s=e.slotsArray[o].eveningSlotsGroup)[0].isBookable==t.isBookable?s[0].eveningSlots.push(a):s[1].eveningSlots.push(a),e.slotsArray[o].eveningSlotsFound=!0}}})),e.slotsArray[o].morningSlotsGroup[0].morningSlots.sort(r.compare),e.slotsArray[o].noonSlotsGroup[0].noonSlots.sort(r.compare),e.slotsArray[o].eveningSlotsGroup[0].eveningSlots.sort(r.compare)}function k(){return d.isConsultationAppointment?d.slotType:d.isERConsultationAppointment?C.ER_TELECONSULTATION:l.serviceTypes.serviceType}if(d.callBasedOnAppointmentStatus=function(){d.search.tentativeScheduleObj.bookingReason&&(d.search.appointmentBookingObj.bookingReason=d.search.tentativeScheduleObj.bookingReason),function(){var e=S.defer();"true"==t.deparam(o.searchParams).isPreQualifierEnabled||null==t.deparam(o.searchParams).isPreQualifierEnabled?d.search.tentativeScheduleObj.selectedService&&d.search.tentativeScheduleObj.selectedService.preQualifierQuestionnaires&&d.search.tentativeScheduleObj.selectedService.preQualifierQuestionnaires.length?d.fillAndValidateQuestionnaire(d.search.tentativeScheduleObj.selectedService.preQualifierQuestionnaires).then((function(t){e.resolve(t)})):e.resolve({valid:!0}):e.resolve({valid:!0});return e.promise}().then((function(e){e.valid?(d.makeAppointmentBookingObj(),p.get("slotReserveTime")&&p.remove("slotReserveTime"),d.search.appointmentBookingObj.patientId&&(d.search.appointmentBookingObj.patientId=void 0),f.configPromise.promise.then((function(){0!=l.serverConfig.isReserveSlotEnabled&&"proposed"!=d.search.appointmentBookingObj.status||d.getPatientForAppointmentObject(),"booked"==d.search.appointmentBookingObj.status&&1==l.serverConfig.isReserveSlotEnabled&&d.reserveSlot()})),d.search.appointmentBookingObj.practitionerResource=d.search.tentativeScheduleObj.selectedPractitioner,d.search.appointmentBookingObj.healthcareServiceResource=d.search.tentativeScheduleObj.selectedService,d.search.appointmentBookingObj.practitionerResource&&(d.search.appointmentBookingObj.bookingReason=void 0,d.search.tentativeScheduleObj.bookingReason=void 0),d.practitionerResource=d.search.tentativeScheduleObj.selectedPractitioner,d.search.appointmentBookingObj.locationResource=d.search.tentativeScheduleObj.locationResource,d.search.appointmentBookingObj.appointmentDate=m("convertIntoTimeZoneObject")(d.search.tentativeScheduleObj.appointmentDate,d.search.appointmentBookingObj.timezone),"booked"==d.search.appointmentBookingObj.status?(d.search.appointmentBookingObj.slotResource=d.search.tentativeScheduleObj.slotResource,d.search.appointmentBookingObj.slotStartDate=m("convertIntoTimeZoneObject")(d.search.tentativeScheduleObj.slotStartDate,d.search.appointmentBookingObj.timezone)):(d.search.appointmentBookingObj.startDate=m("convertIntoTimeZoneObject")(d.search.tentativeScheduleObj.startDate,d.search.appointmentBookingObj.timezone),d.search.appointmentBookingObj.endDate=m("convertIntoTimeZoneObject")(d.search.tentativeScheduleObj.endDate,d.search.appointmentBookingObj.timezone)),0==d.search.appointmentBookingObj.isLogin&&p.add("appointmentObj",d.search.appointmentBookingObj)):d.filledQuestionnaireList=[]}))},d.slotBlockTimer=function(e){clearInterval(d.stopwatchInterval);var t=0;d.stopwatchInterval=setInterval((function(){e<=50&&(clearInterval(d.stopwatchInterval),1==d.search.slotReserved&&(d.search.slotReserved=!1),1==d.search.appointmentRequested&&(d.search.appointmentRequested=!1),d.closeAuthenticationContainerPopup(),p.remove("slotReserveTime")),t||(t=Date.now()),e-=Date.now()-t,t=Date.now(),function(e){var t=e,n=(t=Math.floor(t/1e3))%60,o=n;parseInt(n/10)||(o="0"+o);var a=(t=Math.floor(t/60))%60;o=a+":"+o,parseInt(a/10)||(o="0"+o);var i=(t=Math.floor(t/60))%60;i&&(o=i+":"+o,parseInt(i/10)||(o="0"+o)),d.$apply((function(){d.timeLeftTillSlotFree=o}))}(e)}),50)},d.slotTimer=function(){f.configPromise.promise.then((function(){if(p.get("slotReserveTime")){var e=moment().minute(),t=moment().second(),n=p.get("slotReserveTime").split(":");Number(e)>=Number(n[0])?d.blockingTime=60*(Number(e)-Number(n[0])):d.blockingTime=60*(Number(e)+60-Number(n[0])),Number(t)>Number(n[1])?d.blockingTime+=Number(t)-Number(n[1]):d.blockingTime+=Number(t)+60-Number(n[1]),d.blockingTime=60*l.serverConfig.timeDurationForSlotBlocking-d.blockingTime,d.slotBlockTimer(1e3*d.blockingTime)}else d.blockingTime=l.serverConfig.timeDurationForSlotBlocking,p.add("slotReserveTime",moment().format("mm:ss")),d.slotBlockTimer(6e4*d.blockingTime)}))},d.checkLoggedInUser=function(){d.search.appointmentSlotModalInstance&&d.appointmentSlotModalClose(),!l.serverConfig.paymentGatewayConfig.paymentGatewayEnabledForAppointment||d.search.appointmentBookingObj.practitionerFees&&!r.isEmpty(d.search.appointmentBookingObj.practitionerFees)||d.search.appointmentBookingObj.serviceFees&&!r.isEmpty(d.search.appointmentBookingObj.serviceFees)||!d.search.tentativeScheduleObj.slotResource||r.isEmpty(d.search.tentativeScheduleObj.slotResource)?(s.getUserCookie("user")||p.get("ls-patientId")?(d.callBasedOnAppointmentStatus(),d.search.appointmentBookingObj.isLogin=!0):(d.appointmentSlotModalClose(),d.search.appointmentBookingObj.isLogin=!1,d.openAuthenticationContainerPopup()),t("html, body").animate({scrollTop:0},600)):c.error(m("translate")("patientPortal.appointmentSlot.payment.onlineBookingNotAvailable"))},d.$on("saveAppointmentObj",(function(e,t){d.initialAppointmentSteps()})),d.initialAppointmentSteps=function(){p.get("ls-patientId")?(s.getConfigList(p.get("x-auth-token")),d.callBasedOnAppointmentStatus()):0==d.search.appointmentBookingObj.isLogin&&f.userDetailsPromise.promise.then((function(){d.callBasedOnAppointmentStatus()})),d.authTokenFound=!0},o.searchParams||0!=Object.keys(o).length){var P;if(O(),d.search.searchURLObj={},d.searchButtonEnabled=!1,"true"==(P=null==o.searchParams?o:n.parseParams(o.searchParams)).isPreQualifierEnabled&&null==f.user&&(s.setRedirectAfterLoginUrl(u.path()),u.path("/auth")),Object.keys(P).forEach((function(e){d.search.searchURLObj[e]=P[e]})),d.search.searchURLObj.hcsType&&(d.typeOfService="fhirValueSet.type."+d.search.searchURLObj.hcsType),d.search.searchURLObj.phyID&&(d.typeOfService="searchAppointment.consultant"),d.search.searchURLObj.hcsType&&"Specialty"!=d.search.searchURLObj.hcsType?d.isConsultationAppointment=!1:d.isConsultationAppointment=!0,d.search.searchLocation=d.search.searchURLObj.searchLocation,d.search.searchPhyAndSpec=d.search.searchURLObj.searchPhyAndSpec,d.search.searchURLObj.location&&""!=d.search.searchURLObj.location&&(d.search.searchURLObj.location=d.search.searchURLObj.location.split(","),d.search.searchURLObj.location=d.search.searchURLObj.location.map(Number)),d.search.searchURLObj.locationIdentifier&&""!=d.search.searchURLObj.locationIdentifier&&(d.search.searchURLObj.locationIdentifier=d.search.searchURLObj.locationIdentifier),d.search.searchURLObj.healthcareService&&""!=d.search.searchURLObj.healthcareService&&(d.search.searchURLObj.healthcareService=d.search.searchURLObj.healthcareService.split(","),d.search.searchURLObj.healthcareService=d.search.searchURLObj.healthcareService.map(Number),d.search.searchURLObj.hcsURLId=d.search.searchURLObj.healthcareService),s.getUserCookie("user")?f.configPromise.promise.then((function(){d.fetchGenderList(),d.search.searchURLObj.gender&&(d.search.consultantGenderSelected=m("translate")("patientPortal.appointmentSlot.filter."+d.search.searchURLObj.gender)),d.fetchCommunicationLangList(),d.search.searchURLObj.comlang&&d.consultantCommunicationLangConfigList.forEach((function(e){e.value==d.search.searchURLObj.comlang&&(d.search.consultantCommunicationLangSelected=e.name)}))})):(d.fetchGenderList(),d.search.searchURLObj.gender&&(d.search.consultantGenderSelected=m("translate")("patientPortal.appointmentSlot.filter."+d.search.searchURLObj.gender)),d.fetchCommunicationLangList(),d.search.searchURLObj.comlang&&d.consultantCommunicationLangConfigList.forEach((function(e){e.value==d.search.searchURLObj.comlang&&(d.search.consultantCommunicationLangSelected=e.name)}))),d.search.searchURLObj.slotsFrom&&(d.slotsFrom=m("convertDateStringIntoDateObjectTimeZone")(d.search.searchURLObj.slotsFrom,d.timezone)),d.search.searchURLObj.slotsTo&&(d.slotsTo=m("convertDateStringIntoDateObjectTimeZone")(d.search.searchURLObj.slotsTo,d.timezone)),d.search.searchURLObj.slotType&&(d.slotType=d.search.searchURLObj.slotType),d.search.slotSearchCriteria=d.search.searchURLObj,null==d.search.searchURLObj.healthcareService&&null==d.search.searchURLObj.hcsIdentifier||null!=d.search.searchURLObj.searchPhyAndSpec&&""!=d.search.searchURLObj.searchPhyAndSpec)d.fetchPractitionersOrServicesMappedWithSlots();else r.fetchHealthcareServiceUsingHcsURLID(d).success((function(e){e.hcsList.length>0&&(d.search.slotSearchCriteria.hcsType=e.hcsList[0].hcsType),d.fetchPractitionersOrServicesMappedWithSlots()})).error((function(e){}));p.get("appointmentObj")&&(p.get("appointmentObj").slotResource&&"booked"==p.get("appointmentObj").status?d.search.slotReserved=!0:p.get("appointmentObj").appointmentComment&&(d.search.appointmentRequested=!0),p.get("appointmentObj").registrationFees?(d.registrationFeesReceived=!1,d.MRNFound=!1):d.registrationFeesReceived=!0,d.search.appointmentBookingObj=p.get("appointmentObj"),d.practitionerResource=d.search.appointmentBookingObj.practitionerResource,d.patientId=d.search.appointmentBookingObj.patientId),f.configPromise&&"booked"==d.search.appointmentBookingObj.status&&f.configPromise.promise.then((function(){1==l.serverConfig.isReserveSlotEnabled&&d.slotTimer()}))}else p.get("appointmentObj")&&p.remove("appointmentObj");f.userDetailsPromise&&!o.searchParams?f.userDetailsPromise.promise.then((function(){O()})):p.get("appointmentObj")&&p.get("appointmentObj").patientId&&d.fetchPatient(p.get("appointmentObj").patientId),p.get("ls-patientId")&&u.path().indexOf("/bookAppointment/")<0&&s.removeAllCookies(!1),o.eRHcsId&&(d.isERConsultationAppointment=!0,d.search.appointmentBookingObj.status="waitlist",d.slotType=C.ER_TELECONSULTATION,d.search.appointmentBookingObj.eRhealthcareService={},d.getPatientForAppointmentObject(),d.search&&d.search.patients?D(o.eRHcsId):d.fetchPatientPromise.then((function(){D(o.eRHcsId)}))),d.eRTeleConsultPayByInsurance=function(){d.search.appointmentBookingObj.patientId&&d.payByInsurance()}}function a(e,t,n,o){t.cancel=function(){o.dismiss("cancel"),(!t.changeDateAndTime||0==t.search.slotReserved&&0==t.search.appointmentRequested)&&(t.search.appointmentBookingObj.slotResource={},t.search.checkSlotResourceEmpty=!0,t.search.appointmentBookingObj.appointmentComment="")}}function i(e,t,n,o,a,i,r,s){var p,c;a&&(t.practitionerProfile=i.getProfileView(a),t.practitioner=r,t.practitionerProfile.photo&&t.practitionerProfile.photo.length&&(t.practitionerProfile.userProfilePicture=a.photo[0].data,t.practitionerProfile.userProfilePictureMimeType=a.photo[0].contentType,a.photo[0].data&&(t.profilePicUploaded=!0,p=a.photo[0],c="profilePic",setTimeout((function(){var e="data:"+p.contentType+";base64, "+p.data;document.querySelector("#"+c).src=e}),0))),t.practitionerProfile.gender&&(s.patientSignUp.signUpGenderOptions.includes(t.practitionerProfile.gender)||(t.practitionerProfile.gender=null)));t.cancel=function(){o.dismiss("cancel")}}function r(e,t,n,o,a,i,r,s,p){o.closeAuthenticationContainerPopup=function(){s.processTemplatePath="components/login/authModal.html",o.closeCustomModal()}}function s(e,t,n,o,a,i,r,s,p){n.bulkNotificationCall=function(t,a){var i=s.identifiersFromAppointments(n.selectedAppointments);n.bulkNotificationObj={appointmentIdentifierList:i,customMessage:n.notificationCustomMessage},s.sendBulkNotification(n.bulkNotificationObj).then((function(t){200==t.response.status?(p.success(o("translate")("CA.successMessages.notificationSuccess")),n.cancel(),e.reload()):(p.error(o("translate")("CA.errorMessages.notificationError")),n.cancel())}))},n.cancel=function(){i.dismiss("cancel")},n.toggleSubmitTextArea=function(){return!n.notificationCustomMessage}}function p(e,t,n,o,a,i,r,s,p){e.patientCrud={},e.isPatientAddressUpdated=!1,e.patientCrudHelper={addressObject:[],useCodeWiseCityStateMap:[]};var c={name:"api-info",value:"V1|appVerson|deviceBrand|deviceModel|deviceScreenResolution|deviceOs|deviceOsVersion|deviceNetworkProvider|deviceNetworkType"};e.fetchCountriesListForAddress=function(){a.fetchCountries("V1").then((function(t){t.countries&&t.countries.length>0&&(e.patientCrudHelper.countriesList=t.countries)}),(function(e){o.error(t("translate")("PatientProfileNew.registration.notification.fetchCountriesAPIError"))}))},e.fetchStatesListForSelectedCountry=function(n,i,r){var s="";e.patientCrudHelper.countriesList.forEach((function(e){e.code==n&&(s=e.id)}));var p={countryId:angular.copy(s)};p.countryId&&a.fetchStates(p,i).then((function(t){if(t.states&&t.states.length>0){e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].stateList=t.states;var n=!1;e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].stateList.forEach((function(t){r.state===t.code&&(n=!0,e.fetchCities(r.state,"V1",r))})),n||(r.state="",r.city="")}}),(function(e){o.error(t("translate")("PatientProfileNew.registration.notification.fetchStateAPIError"))}))},e.fetchCitiesListForSelectedState=function(n,i,r){var s="";e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].stateList.forEach((function(e){e.code==n&&(s=e.id)}));var p={stateId:angular.copy(s)};p.stateId&&a.fetchCities(p,"V1").then((function(t){if(t.cities&&t.cities.length>0){e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].cityList=t.cities;var n=!1;e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].cityList.forEach((function(e){r.city===e.code&&(n=!0)})),n||(r.city="")}}),(function(e){o.error(t("translate")("PatientProfileNew.registration.notification.fetchCityAPIError"))}))},e.fetchConfigList=function(){n.getHTTP(i.baseURL+"/selectList/renderProfileConfig",{},c).success((function(t){e.fetchCountriesListForAddress(),e.patientCrudHelper.addressValidation=t.address,e.patientCrudHelper.useCodeListOfAddress=t.useCodesListOfAddressForProfile;var n={country:"",selectedState:"",stateList:[],cityList:[]};e.patientCrudHelper.useCodeListOfAddress.length>0&&(e.patientCrudHelper.useCodeListOfAddress.forEach((function(t){e.patientCrudHelper.useCodeWiseCityStateMap[t]=angular.copy(n)})),e.patientCrudHelper.addressObject.push({line1:"",line2:"",city:"",state:"",district:"",country:"",zipCode:"",useCode:e.patientCrudHelper.useCodeListOfAddress[0],text:"",latitude:"",longitude:""}))})).error((function(){o.error(t("translate")("PatientProfileNew.registration.notification.getConfigAPIError"))}))},e.initPatientAddress=function(){e.fetchConfigList()},e.updatePatientAddress=function(){e.isPatientAddressUpdated=!1,console.log(e.patientCrudHelper.addressObject);var a={};a.address=e.patientCrudHelper.addressObject,a.patientId=e.patientId;var s={patientProfile:a,patientId:e.patientId};n.postHTTP(i.baseURL+"/moPatientProfile/updatePatientAddress",s,!0,c).success((function(n){n.info&&n.info[0]&&1==n.info[0].status?o.success(t("translate")("PatientProfileNew.registration.notification.updateAddressApiSuccess")):o.error(t("translate")("PatientProfileNew.registration.notification.updateAddressApiError")),e.isPatientAddressUpdated=!0,r.close()})).error((function(){o.error(t("translate")("PatientProfileNew.registration.notification.updateAddressApiError")),r.close()}))},e.cancel=function(){r.close()},e.$on("$destroy",(function(){if(e.isPatientAddressUpdated)if(i.serverConfig.paymentGatewayConfig.paymentGatewayEnabledForAppointment&&(e.search.appointmentBookingObj.practitionerFees||e.search.appointmentBookingObj.serviceFees))if("online"==e.paymentType)s.path("/payment/initiate/Appointment/"+e.search.savedAppointmentObj.id+"/CONSULTATION"),res.data&&res.data.code&&"423"==res.data.code&&(o.error(t("translate")("Some thing went Wrong, please contact the system Admin")),s.path("/appointment/details/"+e.search.savedAppointmentObj.id));else if("onsite"==e.paymentType){e.search.payOnSiteObj={serviceline:"CONSULTATION",resourceId:e.search.savedAppointmentObj.id,paymentContext:"Appointment",paymentDetailSource:"PaymentDetailFromAppointment"},p.payOnSite(e.search.payOnSiteObj).then((function(t){s.path("/appointment/details/"+e.search.savedAppointmentObj.id)}))}else s.path("/appointment/details/"+e.search.savedAppointmentObj.id);else s.path("/appointment/details/"+e.search.savedAppointmentObj.id);else e.search.payOnSiteObj={serviceline:"CONSULTATION",resourceId:e.search.savedAppointmentObj.id,paymentContext:"Appointment",paymentDetailSource:"PaymentDetailFromAppointment"},p.payOnSite(e.search.payOnSiteObj).then((function(t){s.path("/appointment/details/"+e.search.savedAppointmentObj.id)}))}))}p.$inject=["$scope","$filter","utilityService","notificationService","signupService","ConfigurationHolder","$modalInstance","$location","patientPortalAppointmentService"],s.$inject=["$route","$rootScope","$scope","$filter","$modal","$uibModalInstance","$uibModalStack","newAppointmentService","notificationService"],r.$inject=["$routeParams","appointmentService","physicianUserService","$scope","$filter","ConfigurationHolder","NgMap","$rootScope","$modal"],i.$inject=["$rootScope","$scope","$filter","$uibModalInstance","practitionerProfile","doctorProfileService","practitioner","ConfigurationHolder"],a.$inject=["$rootScope","$scope","$filter","$uibModalInstance"],o.$inject=["utilityService","$routeParams","abortableHTTPService","appointmentService","patientPortalAppointmentService","userService","localStorageService","notificationService","ConfigurationHolder","$scope","$filter","$location","$modal","$rootScope","$q","doctorProfileService","gtmEventObservableService","healthcareServiceService","StringConstants"],e.exports=angular.module("webconnect.appointments").controller("appointmentBookingCtrl",o),o.$inject=["utilityService","$routeParams","abortableHTTPService","appointmentService","patientPortalAppointmentService","userService","localStorageService","notificationService","ConfigurationHolder","$scope","$filter","$location","$modal","$rootScope","$q","doctorProfileService","gtmEventObservableService","healthcareServiceService","StringConstants"],angular.module("webconnect.appointments").controller("AppointmentSlotModalCtrl",a),a.$inject=["$rootScope","$scope","$filter","$uibModalInstance"],angular.module("webconnect.appointments").controller("viewPractitionerProfileCtrl",i),i.$inject=["$rootScope","$scope","$filter","$uibModalInstance","practitionerProfile","doctorProfileService","practitioner","ConfigurationHolder"],angular.module("webconnect.appointments").controller("paymentDetailPopupCtrl",r),r.$inject=["$routeParams","appointmentService","physicianUserService","$scope","$filter","ConfigurationHolder","NgMap","$rootScope","$modal"],angular.module("webconnect.appointments").controller("appointmentUpdateStatusModalCtrl",s),s.$inject=["$route","$rootScope","$scope","$filter","$modal","$uibModalInstance","$uibModalStack","newAppointmentService","notificationService"],angular.module("webconnect.appointments").controller("patientAddressUpdateModalCtrl",p),p.$inject=["$scope","$filter","utilityService","notificationService","signupService","ConfigurationHolder","$modalInstance","$location","patientPortalAppointmentService"]}).call(this,n(1),n(1))},69:function(e,t,n){(function(t){function n(e,n,o,a,i,r,s,p,c,l,d,m,u,h,f,S,g){c.appointmentStartsFrom=new Date,c.patientId=o.patientId;var v=void 0,b=n.locataionQueryBuilder()._skip(0)._setPhysicalType("bu").getQuery(),C=n.healthCareServiceQueryBuilder()._skip(0)._partOf(0).getQuery();c.appointmentModel={patientCriteria:{constraints:{_skip:0}},locationCriteria:b,healthcareServiceCriteria:C,locationId:void 0,hcsId:void 0,patientId:void 0,totalCount:void 0,skip:0,currentTab:"upcomingAppointmentTab",count:void 0};c.reset=function(){c.appointmentModel.patient="",c.submit()};var A=p.getUserCookie("user");A&&"PATIENT"==A.userType&&(c.loggedInPatientId=A.patientId,c.patientUser=!0),!c.patientId&&A&&"PATIENT"==A.userType&&(c.showPatientBanner=!1),c.appointmentTabState={},c.pageValue=0,c.totalCount=0;var D=new Map,O=new Map;c.loadMapsconfig=function(){c.googleMapsAPIKey=a.serverConfig.googleMapsAPIKey,c.googleMapsUrl="https://maps.googleapis.com/maps/api/js?key="+c.googleMapsAPIKey},c.fetchPatient=function(){(c.appointmentTabState={},c.patientId)&&r.fetchPatient(c.patientId).then((function(e){c.patient=e.patient,"upcomingAppointmentTab"==c.appointmentModel.currentTab?(c.appointmentTabState[c.appointmentModel.currentTab]=y(),c.addTabAndPopulateData(c.appointmentTabState.upcomingAppointmentTab)):"previousAppointmentTab"==c.appointmentModel.currentTab?(c.appointmentTabState[c.appointmentModel.currentTab]=I(),c.addTabAndPopulateData(c.appointmentTabState.previousAppointmentTab)):(c.appointmentTabState[c.appointmentModel.currentTab]=k(),c.addTabAndPopulateData(c.appointmentTabState.cancelledAppointmentTab))}))},c.addTabAndPopulateData=function(e){c.createInitialSearchCriteria(e),c.fetchAppointments(e)},c.createInitialSearchCriteria=function(e){c.criteriaForAppointments={constraints:{_count:10,_skip:c.appointmentModel.skip,associatedTaskCriteria:{constraints:{status:f.TASK_STATUS_REQUESTED,basedOnType:"Appointment",visible:!0},sendTaskDetails:!1}},includePatientProfile:!0},c.patient&&(c.criteriaForAppointments.constraints["actorPatient:in"]=c.patient.id),1===e.tab||2===e.tab?(c.criteriaForAppointments.constraints.endDate=e.dateCriteria+c.appointmentStartsFrom.toJSON(),c.criteriaForAppointments.constraints["status:not-in"]=e.appointmentTabStateList.join(",")):c.criteriaForAppointments.constraints.status=e.appointmentTabStateList.join(","),2===e.tab?c.criteriaForAppointments.constraints["_sort:desc"]="start.value":c.criteriaForAppointments.constraints["_sort:asc"]="start.value",c.appointmentModel.patientId&&(c.criteriaForAppointments.constraints.actorPatient=c.appointmentModel.patientId),c.appointmentModel.locationId&&(c.criteriaForAppointments.constraints.actorLocation=c.appointmentModel.locationId),c.appointmentModel.hcsId&&(c.criteriaForAppointments.constraints.actorHealthcareService=c.appointmentModel.hcsId),c.appointmentModel.skip&&(c.criteriaForAppointments.constraints._skip=c.appointmentModel.skip),e.criteria=c.criteriaForAppointments},c.fetchAppointments=function(e){c.fetchAppointmentsOnTabCriteria(e)},c.fetchAppointmentDetailsV2=function(e){e.forEach((function(e){e.patient&&e.patient.id&&(e.patient.id=e.patient.id),e.endDate=l("convertIntoTimeZoneObject")(e.endDate,e.timezone),e.startDate=l("convertIntoTimeZoneObject")(e.startDate,e.timezone),e.showAppointmentDetails={},e.currentDate=moment().toDate(),e.location&&e.location.latitude&&e.location.longitude&&(e.showAppointmentDetails.locationUrlLink="https://www.google.com/maps/dir/?api=1&destination="+e.location.latitude+","+e.location.longitude)}))},c.fetchAppointmentsOnTabCriteria=function(e){var t=e;A&&t.criteria.constraints.actorPatient&&A.patientId==t.criteria.constraints.actorPatient&&a.showSelfRecordRequest&&(delete t.criteria.constraints.actorPatient,t.criteria.constraints.authParams="showSelf"),r.fetchAppointmentV2(t.criteria).then((function(n){t.appointments=n.appointment,t.offset=n.totalCount,c.totalCount=1==e.tab?e.offset:n.totalCount,t.appointmentsLoaded=!0,c.fetchAppointmentDetailsV2(t.appointments)}))},c.fetchAppointmentDetails=function(e){e.forEach((function(e){e.appointmentDetails=l("findElementInExtensionList")(e.extension,"appointmentDetails"),e.showAppointmentDetails=e.appointmentDetails?e.appointmentDetails:{},e.extension.forEach((function(t){"appointmentDetails"==t.url&&(t.value[0].characteristic&&(e.instruction=t.value[0].characteristic[0].coding[0].display),e.timezone=t.value[0].timezone)})),e.currentDate=moment().toDate(),e.patientName=e.showAppointmentDetails.patientName,e.cancelComment="",e.healthCareService={},e.participant.forEach((function(t){t.actorHealthcareService&&t.actorHealthcareService.id?e.showRescheduleAndCancel=!0:e.showRescheduleAndCancel=!1,e.appointmentDetails?e.showAppointmentDetails=angular.copy(e.appointmentDetails):t.type.length>0&&"HCS"==t.type[0].text&&c.fetchParticipantHCS(t,e)})),e.startDate=l("convertIntoTimeZoneObject")(e.start.value,e.timezone),e.endDate=l("convertIntoTimeZoneObject")(e.end.value,e.timezone),e.identifier&&e.identifier.length>0&&(e.fillerIdentifier=e.identifier[0].value),r.fetchQuestionnaire(e).then((function(t){e=t.appointment})),e.participant.forEach((function(t){if(t.actorPractitioner&&"primary performer"==t.type[0].text){var n=t.actorPractitioner.id;if(D.has(n))e.practitioner=angular.copy(D[n]),e.practitioner.identifier=angular.copy(D[n].identifier),e.showAppointmentDetails.speciality=D[n].specialtyText;else r.fetchPractitioner(t.actorPractitioner.id).then((function(t){e.practitioner=t.practitioner})).then((function(){D.set(n),D[n]=e.practitioner,e.showAppointmentDetails.speciality=D[n].specialtyText}))}else if(t.actorPatient&&"subject"==t.type[0].text){n=t.actorPatient.id;if(O.has(n))e.patient=O[n];else r.getPatientFhir(n).then((function(t){var n,o,a;if(e.patient=(n={firstName:t.patient.lowerCaseName[0].given?t.patient.lowerCaseName[0].given[0]:null,lastName:t.patient.lowerCaseName[0].family?t.patient.lowerCaseName[0].family[0]:null,photo:t.patient.photo,displayName:t.patient.lowerCaseName[0].text,id:t.patient.id,gender:t.patient.gender,dob:t.patient.birthDate.value,patientIdentifiers:[{identifierAttributes:t.patient.identifier[0].value,identifierSystem:t.patient.identifier[0].system,identifierTypeText:t.patient.identifier[0].type.text}],phoneList:[{value:t.patient.telecom[0].value}],lowerCaseName:t.patient.lowerCaseName},o="dob",a=t.patient.birthDate.value,o in n?Object.defineProperty(n,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[o]=a,n),t.patient.telecom&&t.patient.telecom.length>0)for(var i=0;i<t.patient.telecom.length;i++)"phone"==t.patient.telecom[i].system&&(e.patient.phoneList=[{value:t.patient.telecom[i].value}]);if(t.patient.identifier)for(i=0;i<t.patient.identifier.length;i++)"patientId"==t.patient.identifier[i].type.text&&(e.patient.patientIdentifiers=[{identifierAttributes:t.patient.identifier[i].value}])})).then((function(){O.set(n),O[n]=e.patient}))}else if(t.actorHealthcareService)e.healthcareService=t.actorHealthcareService,c.fetchLocation(t.actorHealthcareService.id,e);else if(t.actorLocation&&!t.actorHealthcareService){r.fetchLocation(t.actorLocation.id).then((function(t){var n=t.location;e.location=n,e.showAppointmentDetails.locationDetails=n.name?n.name:"",n.position&&(e.showAppointmentDetails.positionCoordinates=[n.position.latitude.value,n.position.longitude.value],e.showAppointmentDetails.locationUrlLink=c.getDirectionUrl(n.position))}))}})),e.paid=!1,r.fetchPaymentDetails(e.id).then((function(t){e.paymentDetailForPopup=t.paymentDetail,!t.paymentDetail||s.isEmpty(t.paymentDetail)||t.paymentDetail&&"Captured"==t.paymentDetail.transactionStatus&&"online"==t.paymentDetail.paymentMethod?e.paid=!0:e.paid=!1}))}))},c.fetchLocation=function(e,t){r.fetchHCSDetails(e).then((function(e){t.healthcareService=e.healthCareService,t.location=e.healthCareService.location[0],t.showAppointmentDetails.location=e.healthCareService.location[0],t.showAppointmentDetails.location.identifier=e.healthCareService.location[0].identifier,t.showAppointmentDetails.locationId=t.healthcareService.location[0].id,t.showAppointmentDetails.locationDetails=t.healthcareService.location?t.healthcareService.location[0].name:"",t.showAppointmentDetails.department=t.healthcareService.providedBy&&t.healthcareService.providedBy.name?t.healthcareService.providedBy.name:"",e.healthCareService.location[0].position&&(t.showAppointmentDetails.positionCoordinates=[e.healthCareService.location[0].position.latitude.value,e.healthCareService.location[0].position.longitude.value],t.showAppointmentDetails.locationUrlLink=c.getDirectionUrl(e.healthCareService.location[0].position)),t.instruction=t.healthcareService.characteristic[0].coding[0].display}))},c.preValidateTask=function(e,t){var n={basedOn:e.id,basedOnType:"Appointment"};return"cancelRequest"==t?n.reasonCode="cancelAppointment":"rescheduleRequest"==t?n.reasonCode="rescheduleAppointment":"confirmRequest"==t&&(n.reasonCode="confirmAppointment"),g.preValidate(n).then((function(n){"cancelRequest"==t?c.cancelAppointmentRequestModal(e):"rescheduleRequest"==t?c.rescheduleAppointmentRequestModal(e):"confirmRequest"==t&&c.confirmAppointmentRequestModal(e)}),(function(t){if("rescheduleAttemptReachedException"==t.data.errors[0].validationErrors[0].code)c.rescheduleRequestNotifyAdminModal(e);else if("cancelAttemptReachedException"==t.data.errors[0].validationErrors[0].code)c.cancelRequestNotifyAdminModal(e);else{var n=t.data.errors[0].validationErrors;for(var o in n)n.hasOwnProperty(o)&&S.error(l("translate")("patientPortal.appointmentPreValidateTaskError."+n[o].code))}}))},c.pagingCountForward=function(e){angular.forEach(c.appointmentTabState,(function(t,n){t.tab===e&&(t.pageValue=t.pageValue+10,c.pageValue=t.pageValue,c.appointmentModel.skip||(c.appointmentModel.skip=0),c.appointmentModel.skip=c.pageValue?c.appointmentModel.skip+10:0,c.appointmentModel.count=c.appointmentModel.count?c.appointmentModel.count:10),c.submit()}))},c.pagingCountBackward=function(e){angular.forEach(c.appointmentTabState,(function(t,n){t.tab===e&&(t.pageValue=t.pageValue-10,c.pageValue=t.pageValue,c.appointmentModel.skip=c.pageValue?c.appointmentModel.skip-10:0),c.submit()}))},c.changeTab=function(e){1==e&&c.appointmentTabState.upcomingAppointmentTab&&(c.appointmentTabState.upcomingAppointmentTab=y(),c.addTabAndPopulateData(c.appointmentTabState.upcomingAppointmentTab)),2==e&&(c.appointmentTabState.previousAppointmentTab=I(),c.addTabAndPopulateData(c.appointmentTabState.previousAppointmentTab)),3==e&&(c.appointmentTabState.cancelledAppointmentTab=k(),c.addTabAndPopulateData(c.appointmentTabState.cancelledAppointmentTab)),c.tab=e,angular.forEach(c.appointmentTabState,(function(t,n){t.tab===e&&(c.totalCount=t.offset,c.pageValue=t.pageValue)}))},c.fetchNextOrPreviousAppointments=function(e,t){c.appointmentTabState.upcomingAppointmentTab.tab===t?(c.appointmentTabState.upcomingAppointmentTab.criteria.constraints._skip=e,c.fetchAppointmentsOnTabCriteria(c.appointmentTabState.upcomingAppointmentTab)):c.appointmentTabState.previousAppointmentTab&&c.appointmentTabState.previousAppointmentTab.tab===t?(c.appointmentTabState.previousAppointmentTab.criteria.constraints._skip=e,c.fetchAppointmentsOnTabCriteria(c.appointmentTabState.previousAppointmentTab)):(c.appointmentTabState.cancelledAppointmentTab.criteria.constraints._skip=e,c.fetchAppointmentsOnTabCriteria(c.appointmentTabState.cancelledAppointmentTab))},c.cancelRequestModal=function(e){m.open({templateUrl:"components/appointments/patientPortal/cancelRequest.html",controller:"appointmentModalCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:c.appointmentTabState,remarks:e.remarks,patientRemarks:e.patientRemarks}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.reSchedule=function(e){c.rescheduleEnabled=!0,c.bookAgainEnabled=!1;m.open({templateUrl:"components/appointments/patientPortal/appointmentSlot-RescheduleBookAgain.html",controller:"appointmentModalCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:c.appointmentTabState,bookAgainEnabled:!1,rescheduleEnabled:!0}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.patientCheckIn=function(e){s.onCheckinBtnClick(e)},e.configPromise.promise.then((function(){T()}));var T=function(){var e,t="https://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false&key="+a.serverConfig.googleMapsAPIKey;(e=document.createElement("script")).type="text/javascript",e.src=t,document.body.appendChild(e)};function y(){return{appointments:{},appointmentsLoaded:!0,appointmentTabStateList:["cancelled"],dateCriteria:">=",criteria:{},tab:1,pageValue:c.pageValue,offset:0}}function I(){return{appointments:{},appointmentsLoaded:!0,appointmentTabStateList:["cancelled"],dateCriteria:"<=",criteria:{},tab:2,pageValue:c.pageValue,offset:0}}function k(){return{appointments:{},appointmentsLoaded:!0,appointmentTabStateList:["cancelled"],criteria:{},tab:3,pageValue:c.pageValue,offset:0}}c.downloadAppointmentPDF=function(e){var t={timeFormat:"hh:mm a",timezone:e.timezone,fileName:"appointment"+e.id+".pdf",appointmentId:e.id,coverageImageType:"THUMBNAIL"};s.downloadAppointmentPDF(t).then((function(e){}))},c.bookAgain=function(e){c.bookAgainEnabled=!0,c.rescheduleEnabled=!1;m.open({templateUrl:"components/appointments/patientPortal/appointmentSlot-RescheduleBookAgain.html",controller:"appointmentModalCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:"previous",bookAgainEnabled:!0,rescheduleEnabled:!1}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.getDirectionUrl=function(e){return"https://www.google.com/maps/dir/?api=1&destination="+e.latitude.value+","+e.longitude.value},c.appointmentDetail=function(e){"VIRTUAL_MEETING"===e.type||"MEETING"===e.type?d.path("/meetingDetails/"+e.id):d.path("/appointment/details/"+e.id)},i.getMap().then((function(e){c.map=e,e.addListener("resize",(function(){var t={lat:c.appointmentDetail.positionCoordinates[0],lng:c.appointmentDetail.positionCoordinates[1]};e.setCenter(t)}))})),t(window).resize((function(){c.isPageLoadComplete()&&google.maps.event.trigger(c.map,"resize")})),c.openWindow=function(e){window.open(e)},c.getDirectionUrl=function(e){return"https://www.google.com/maps/dir/?api=1&destination="+e.latitude.value+","+e.longitude.value},c.isPageLoadComplete=function(){return!!(c.patient&&c.practitioner&&c.appointmentDetail&&c.appointmentDetail.healthcareService)},c.makePaymentNow=function(e){if(!e.patient.addressList||e.patient.addressList.length<=0){c.patientId=e.patient.id,c.appointmentId=e.id,c.isPatientAddressUpdated=!1;m.open({templateUrl:"components/appointments/patientPortal/templates/patientAddressInputDetails.html",controller:"patientAddressModalForPaymentCtrl",scope:c,size:"sm",resolve:{}})}else d.path("/payment/initiate/Appointment/"+e.id+"/CONSULTATION")},c.openInstructionsModal=function(e,t){m.open({templateUrl:"components/appointments/patientPortal/healthcareServiceInstructions.html",controller:"appointmentInstructionsModalCtrl",resolve:{appointment:function(){c.appointment=e},instructions:function(){c.appointment.instructions=t}},windowClass:"xs-overlay",scope:c,size:"md"})},c.cancelQuestionnaireResponse=function(e){c.cancelQRId=e;var t=h.openCancelQRModal(c);return t.result.then((function(t){t.status&&c.appointment.questionnaires.forEach((function(t,n){t.id===e&&c.appointment.questionnaires.splice(n,1)})),c.openQuestionnairesModal(c.appointment,c.appointment.questionnaires)})),t.result},c.openQuestionnairesModal=function(e,t){m.open({templateUrl:"components/appointments/patientPortal/assignedQuestionnairesModal.html",controller:"appointmentQuestionnairesModalCtrl",resolve:{appointment:function(){c.appointment=e},questionnaires:function(){c.appointment.questionnaires=t}},windowClass:"xs-overlay",scope:c,size:"md"}).result.then((function(t){t&&t.cancelQRId?c.cancelQuestionnaireResponse(t.cancelQRId):t&&t.addMore&&c.addMoreQuestionnaires(e)}))},c.addMoreQuestionnaires=function(e){c.selectedAppointmentId=e?e.id:"",d.path("/sendQuestionnaire/"+c.patient.id+"/"+c.selectedAppointmentId)},c.onQuestionnairePreview=function(){var e={openAddMoreQuestionnaireModal:!0,tab:c.tab};sessionStorage.setItem("appointmentListRedirectionObject",JSON.stringify(e))},c.cancelAppointmentRequestModal=function(e){m.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:c.appointmentTabState,cancelRequest:!0}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.rescheduleRequestNotifyAdminModal=function(e){m.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,rescheduleRequestNotifyAdmin:!0}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.cancelRequestNotifyAdminModal=function(e){m.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,cancelRequestNotifyAdmin:!0}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.rescheduleAppointmentRequestModal=function(e){m.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,rescheduleRequest:!0}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.confirmAppointmentRequestModal=function(e){m.open({templateUrl:"components/appointments/patientPortal/templates/AppointmentRequestOnlyFlowWithoutSlotsParent.html",controller:"appointmentRequestTaskWorkflowCtrl",resolve:{returnModalParams:function(){return{appointment:e,appointmentTabState:c.appointmentTabState,confirmRequest:!0}}},windowClass:"xs-overlay",scope:c,size:"md"})},c.redirectToHelpDeskPortal=function(e){d.url("inbox/helpdesk/newQuery?contextType=appointment&contextId="+e.id)},c.executeAppointmentAction=function(e,t){"rescheduleRequest"==t||"cancelRequest"==t?c.preValidateTask(e,t):"rescheduleAppointment"==t?c.reSchedule(e):"cancelAppointment"==t?c.cancelRequestModal(e):"checkIn"==t?c.patientCheckIn(e):"confirmRequest"==t?c.preValidateTask(e,t):"print"==t?c.downloadAppointmentPDF(e):"submitQuery"==t?c.redirectToHelpDeskPortal(e):"bookAgain"==t?c.bookAgain(e):"payNow"==t?c.makePaymentNow(e):"join"==t?c.redirectToMeeting(e.id):"waitingRoom"==t&&c.redirectToWaitingRoom(e.id)},c.redirectToWaitingRoom=function(e){d.url("/teleConsultationWaitingRoom/"+e)},c.redirectToMeeting=function(e){window.open(a.frontEndURL+"/meeting/start/"+e)},c.submit=function(){var e,t=(e={},c.appointmentModel&&(c.appointmentModel.patient&&(e.patientId=c.appointmentModel.patient.id),c.appointmentModel.location&&(e.locationId=c.appointmentModel.location.id),c.appointmentModel.hcs&&(e.hcsId=c.appointmentModel.hcs.id),(c.appointmentModel.skip||0==c.appointmentModel.skip)&&(e.skip=c.appointmentModel.skip),(c.appointmentModel.count||0==c.appointmentModel.count)&&(e.count=c.appointmentModel.count),!c.appointmentModel.currentTab||(e.currentTab=c.appointmentModel.currentTab)),e);o.patientId?d.path("/patient/"+o.patientId+"/appointmentsList/"+l("convertJSONToQueryString")(t)):d.path("/appointmentsList/"+l("convertJSONToQueryString")(t))},c.resetCountAndSkipOnTabChange=function(e){c.pageValue=0,c.appointmentModel.skip=0,c.appointmentModel.currentTab=1==e?"upcomingAppointmentTab":2==e?"previousAppointmentTab":"cancelledAppointmentTab",c.submit()},o.searchParams?((v=l("parseSearchParamsStringToObject")(o.searchParams))||(v={}),v&&(c.appointmentModel.patientId=v.patientId?v.patientId:void 0,c.appointmentModel.locationId=v.locationId?v.locationId:void 0,c.appointmentModel.hcsId=v.hcsId?v.hcsId:void 0,c.appointmentModel.skip=v.skip?parseInt(v.skip):void 0,c.appointmentModel.currentTab=v.currentTab?v.currentTab:void 0,c.appointmentModel.count=v.count?parseInt(v.count):10,c.pageValue=v.skip?parseInt(v.skip):0,"upcomingAppointmentTab"==v.currentTab?c.tab=1:"previousAppointmentTab"==v.currentTab?c.tab=2:c.tab=3)):(c.tab=1,c.changeTab(1)),c.patientId?c.fetchPatient():"upcomingAppointmentTab"==c.appointmentModel.currentTab?(c.appointmentTabState[c.appointmentModel.currentTab]=y(),c.addTabAndPopulateData(c.appointmentTabState.upcomingAppointmentTab)):"previousAppointmentTab"==c.appointmentModel.currentTab?(c.appointmentTabState[c.appointmentModel.currentTab]=I(),c.addTabAndPopulateData(c.appointmentTabState.previousAppointmentTab)):(c.appointmentTabState[c.appointmentModel.currentTab]=k(),c.addTabAndPopulateData(c.appointmentTabState.cancelledAppointmentTab))}function o(e,t,n,o){t.cancel=function(){o.dismiss("cancel")}}function a(e,t,n,o,a,i,r,s,p){t.cancel=function(){o.dismiss("cancel")},t.cancelQuestionnaireResponse=function(e){o.close({cancelQRId:e})},t.noticeInvalidQuestionnaire=function(){i.notice(n("translate")("questionnair.questionnaireResponses.notAllowed"))},t.fillQuestionnaireResponse=function(e){e.external?(s.cookie.set("externalQuestionnaire.previousRoute",r.url()),r.path("/externalQuestionnairePatResponse/"+e.applicationId)):r.path("/patResponse/"+e.applicationId)},t.addMoreQuestionnaires=function(){o.close({addMore:!0})},t.viewQuestionnaireResponse=function(e){r.path("/showPatientResponse/"+e.applicationId)},t.noticeInvalidQuestionnaire=function(){i.notice(n("translate")("questionnair.questionnaireResponses.notAllowed"))}}function i(e,t,n,o,a,i,r,s,p,c,l,d){t.cancel=function(){o.close()},t.selectedQuestionnaires=[],t.fetchQuestionnaireList=function(e){t.loaded=!1;var n={constraints:{"extension:url":"SearchTag.active|true",status:"PUBLISHED"}};p.serverConfig.notAssignableQuestionnaireTypes&&p.serverConfig.notAssignableQuestionnaireTypes.length&&(n.constraints["type:not-in"]=p.serverConfig.notAssignableQuestionnaireTypes.join(",")),c.searchQuestionnaire(n,!0,!0).then((function(e){e.data&&e.data.list&&e.data.list.length&&(t.questionnaireList=e.data.list)}))},t.sendQuestionnaires=function(){m(t.selectedQuestionnaires).then((function(e){e.done?(e.mailSent?a.success(n("translate")("questionnair.sendQuestionnaire.mailSendSuccess")):a.notice(n("translate")("questionnair.sendQuestionnaire.withoutMailSuccess")),t.cancel()):a.error(n("translate")("questionnair.sendQuestionnaire.mailSendError"))}))};var m=function(e){var o=d.defer(),a=[];e.forEach((function(e){var t=n("findIdentifier")(e.identifier,"baseQuestinnaireId");t?a.push(t.toString()):a.push(e.id.toString())}));var i={questionnaireIds:a,appointmentId:t.selectedAppointmentId,patientId:t.patient.id,name:t.patient.name};return l.postHTTP(p.baseURL+"/questionnaire/sendMultiQuestionnaireEmailToPatient",i).success((function(e,t,n,a){o.resolve({done:!0,mailSent:e.mailSent,smsSent:e.smsSent})})).error((function(e,t,n,a){o.resolve({done:!1})})),o.promise}}function r(e,t,n,o,a,i,r,s,p){e.patientCrud={},e.isPatientAddressUpdated=!1,e.patientCrudHelper={addressObject:[],useCodeWiseCityStateMap:[]};var c={name:"api-info",value:"V1|appVerson|deviceBrand|deviceModel|deviceScreenResolution|deviceOs|deviceOsVersion|deviceNetworkProvider|deviceNetworkType"};e.fetchCountriesListForAddress=function(){a.fetchCountries("V1").then((function(t){t.countries&&t.countries.length>0&&(e.patientCrudHelper.countriesList=t.countries)}),(function(e){o.error(t("translate")("PatientProfileNew.registration.notification.fetchCountriesAPIError"))}))},e.fetchStatesListForSelectedCountry=function(n,i,r){var s="";e.patientCrudHelper.countriesList.forEach((function(e){e.code==n&&(s=e.id)}));var p={countryId:angular.copy(s)};p.countryId&&a.fetchStates(p,i).then((function(t){if(t.states&&t.states.length>0){e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].stateList=t.states;var n=!1;e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].stateList.forEach((function(t){r.state===t.code&&(n=!0,e.fetchCities(r.state,"V1",r))})),n||(r.state="",r.city="")}}),(function(e){o.error(t("translate")("PatientProfileNew.registration.notification.fetchStateAPIError"))}))},e.fetchCitiesListForSelectedState=function(n,i,r){var s="";e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].stateList.forEach((function(e){e.code==n&&(s=e.id)}));var p={stateId:angular.copy(s)};p.stateId&&a.fetchCities(p,"V1").then((function(t){if(t.cities&&t.cities.length>0){e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].cityList=t.cities;var n=!1;e.patientCrudHelper.useCodeWiseCityStateMap[r.useCode].cityList.forEach((function(e){r.city===e.code&&(n=!0)})),n||(r.city="")}}),(function(e){o.error(t("translate")("PatientProfileNew.registration.notification.fetchCityAPIError"))}))},e.fetchConfigList=function(){n.getHTTP(i.baseURL+"/selectList/renderProfileConfig",{},c).success((function(t){e.fetchCountriesListForAddress(),e.patientCrudHelper.addressValidation=t.address,e.patientCrudHelper.useCodeListOfAddress=t.useCodesListOfAddressForProfile;var n={country:"",selectedState:"",stateList:[],cityList:[]};e.patientCrudHelper.useCodeListOfAddress.length>0&&(e.patientCrudHelper.useCodeListOfAddress.forEach((function(t){e.patientCrudHelper.useCodeWiseCityStateMap[t]=angular.copy(n)})),e.patientCrudHelper.addressObject.push({line1:"",line2:"",city:"",state:"",district:"",country:"",zipCode:"",useCode:e.patientCrudHelper.useCodeListOfAddress[0],text:"",latitude:"",longitude:""}))})).error((function(){o.error(t("translate")("PatientProfileNew.registration.notification.getConfigAPIError"))}))},e.initPatientAddress=function(){e.fetchConfigList()},e.updatePatientAddress=function(){e.isPatientAddressUpdated=!1,console.log(e.patientCrudHelper.addressObject);var a={};a.address=e.patientCrudHelper.addressObject,a.patientId=e.patientId;var s={patientProfile:a,patientId:e.patientId};n.postHTTP(i.baseURL+"/moPatientProfile/updatePatientAddress",s,!0,c).success((function(n){n.info&&n.info[0]&&1==n.info[0].status?o.success(t("translate")("PatientProfileNew.registration.notification.updateAddressApiSuccess")):o.error(t("translate")("PatientProfileNew.registration.notification.updateAddressApiError")),e.isPatientAddressUpdated=!0,r.close()})).error((function(){o.error(t("translate")("PatientProfileNew.registration.notification.updateAddressApiError")),r.close()}))},e.cancel=function(){r.close()},e.$on("$destroy",(function(){e.isPatientAddressUpdated&&s.path("/payment/initiate/Appointment/"+e.appointmentId+"/CONSULTATION")}))}r.$inject=["$scope","$filter","utilityService","notificationService","signupService","ConfigurationHolder","$modalInstance","$location","patientPortalAppointmentService"],i.$inject=["$rootScope","$scope","$filter","$uibModalInstance","notificationService","$location","localStorageService","$modal","ConfigurationHolder","questionnaireService","utilityService","$q"],a.$inject=["$rootScope","$scope","$filter","$uibModalInstance","appointment","notificationService","$location","localStorageService","$modal"],o.$inject=["$rootScope","$scope","$filter","$uibModalInstance"],n.$inject=["$rootScope","utilityService","$routeParams","ConfigurationHolder","NgMap","appointmentService","patientPortalAppointmentService","userService","$scope","$filter","$location","$modal","$route","questionnaireService","StringConstants","notificationService","referralService"],e.exports=angular.module("webconnect.appointments").controller("appointmentListingCtrl",n),n.$inject=["$rootScope","utilityService","$routeParams","ConfigurationHolder","NgMap","appointmentService","patientPortalAppointmentService","userService","$scope","$filter","$location","$modal","$route","questionnaireService","StringConstants","notificationService","referralService"],angular.module("webconnect.appointments").controller("appointmentInstructionsModalCtrl",o),o.$inject=["$rootScope","$scope","$filter","$uibModalInstance"],angular.module("webconnect.appointments").controller("appointmentQuestionnairesModalCtrl",a),a.$inject=["$rootScope","$scope","$filter","$uibModalInstance","appointment","notificationService","$location","localStorageService","$modal"],angular.module("webconnect.appointments").controller("addMoreQuestionnaireAppointmentCtrl",i),i.$inject=["$rootScope","$scope","$filter","$uibModalInstance","notificationService","$location","localStorageService","$modal","ConfigurationHolder","questionnaireService","utilityService","$q"],angular.module("webconnect.appointments").controller("patientAddressModalForPaymentCtrl",r),r.$inject=["$scope","$filter","utilityService","notificationService","signupService","ConfigurationHolder","$modalInstance","$location","patientPortalAppointmentService"]}).call(this,n(1))}}]);