(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{10:function(e,o,t){(function(o,t){e.exports=angular.module("auth").controller("loginController",["vcRecaptchaService","$routeParams","$rootScope","$modal","$q","$window","$scope","$http","$rootElement","$location","userService","ConfigurationHolder","$filter","utilityService","localStorageService","customLocalStorageService","downloadStatusService","eventWebSocketService","$translate","confirmBoxService","notificationService","OAuthAccountResponse","signupService","gtmEventObservableService","$controller","tokenService","loginUsingNonceTokenService","ApplicationStateService",function(e,r,n,s,i,a,l,c,u,g,d,p,h,f,m,v,T,w,k,P,A,S,C,U,L,y,F,E){if("GUEST"==m.get("userType")&&d.removeAllCookies(!1),l.thirdPartyAuthenticationFlow=!1,r.accessTokenID&&null!=r.accessTokenID&&null!==r.accessTokenID&&(l.thirdPartyAuthenticationFlow=!0),r.nonceToken||r.nonceTokenForLoggedInUser?r.nonceRedirectUrl&&d.setUserCookie("nonceRedirectUrl",r.nonceRedirectUrl):d.removeCookie("nonceRedirectUrl"),l.clientConfiguration=function(){return f.loadClientConfiguration()},n.showLoginPage=navigator.cookieEnabled,l.idxAuthCall=function(){if(!navigator.cookieEnabled)return n.showLoginPage=!1,!1;f.postHTTP(p.baseURL+"/Oauth2/index",{source:"web",provider:"idx"}).success((function(e,o,t,r){n.showSpinner=!0,a.location.href=e.loginUrl}))},l.signUpOrLoginWithFb=function(e,o){console.log("SignUp With facebook option for save state of controller is "+e),m.set("saveControllerState",e),e&&m.set("savedStateOfApplication",g.path()),"login"===o?(m.set("login",!0),a.location.href=l.clientConfiguration().baseURL+"/oauthCallBack/authenticateOAuth?provider=facebook&actionFlow=login"):a.location.href=l.clientConfiguration().baseURL+"/oauthCallBack/authenticateOAuth?provider=facebook"},l.errorParam=r.urlFilter,l.otpSentToDevice=null,l.response=null,l.widgetId=null,l.retiresMoreThanThree=!1,l.disableForm=!1,l.loginType=p.signInOptionAllowed.defaultSignIn,l.loginTabs={showLoginTabs:Object.keys(p.signInOptionAllowed.SignInFlow).length>1,openLoginUsingOTPTab:!!p.signInOptionAllowed.SignInFlow.withOTP},r.username&&""!=r.username&&(l.username=r.username,l.loginType="USERNAME"),n.loginType&&(l.loginWith=n.loginType),m.get("ls-patientId")&&g.path().indexOf("/bookAppointment/")<0&&d.removeAllCookies(!1),l.resetAuthenticationForm=function(e){l.loginType=e,l.message=""},l.showHidePassword=function(e){var t=o(e.target),r=t.next("input");"password"===r.attr("type")?(r.attr("type","text"),t.removeClass("icon-show_password").addClass("icon-hide_password")):(r.attr("type","password"),t.removeClass("icon-hide_password").addClass("icon-show_password"))},l.model={key:p.captchaKey},l.setResponse=function(e){l.response=e},l.setWidgetId=function(e){l.widgetId=e},l.raiseGTMEvents=function(e,o){U.raiseEvent({name:e,data:o})},l.fetchAdfsLoginUrl=function(){f.postHTTP(p.baseURL+"/oauth2/index",{source:"web"},!1,null).success((function(e,o,t,r){a.location.href=e.loginUrl})).error((function(e,o,t,r){console.log("error")}))},l.changeLoginTab=function(e){switch(e){case p.signInOptionAllowed.SignInFlow.withOTP:l.message="",l.loginTabs.openLoginUsingOTPTab=!0,l.loginType=p.signInOptionAllowed.SignInFlow.withOTP;break;case p.signInOptionAllowed.SignInFlow.withPassword:l.message="",l.loginTabs.openLoginUsingOTPTab=!1,l.loginType=p.signInOptionAllowed.defaultSignIn}},l.loginType&&null!=l.loginType||(l.loginType=d.getUserCookie("loginType")),null!=r.provider&&null!=r.accessTokenID){var b={};l.provider=r.provider,b.provider=r.provider,b.accessTokenID=r.accessTokenID,r.linkAccount&&"null"!=r.linkAccount&&(b.linkAccount=r.linkAccount),d.getUserCookie("x-auth-token")?b.linkAccount&&(r.linkMsg==S.ACCOUNT_LINKED_TO_OTHER_USER?A.error(h("translate")("login.OAuth.accountLinkedToOtherUser")):r.linkMsg==S.ACCOUNT_LINKED_SUCCESSFULLY?A.success(h("translate")("login.OAuth.accountLinkedSuccessfully")):r.linkMsg==S.ACCOUNT_UNABLE_TO_LINK_TO_USER?A.error(h("translate")("login.OAuth.accountUnableToLink")):r.linkMsg==S.ACCOUNT_ALREADY_LINKED&&A.error(h("translate")("login.OAuth.accountAlreadyLinkedToUser")),g.search({}),g.path("/updateProfile")):"ADFS"==b.provider.toUpperCase()?f.postHTTP(p.baseURL+"/oauth2/authenticate",b).success((function(e,o,t,r){var n=p.frontEndURL;n.indexOf("#")>=0&&(n=n.replace("#","")),e.token?l.handleSuccessfulLogin(e,o,t,r):A.error(h("translate")("login.adfs.genericError"))})):"IDX"==b.provider.toUpperCase()?f.postHTTP(p.baseURL+"/oauth2/authenticate",b).success((function(e,o,t,r){var n=p.frontEndURL;n.indexOf("#")>=0&&(n=n.replace("#","")),e.token?l.handleSuccessfulLogin(e,o,t,r):A.error(h("translate")("login.adfs.genericError"))})).error((function(e,o,t,r){g.search({}),A.error(h("translate")("login.IDX.genericError")),g.path(p.logout.redirectUrl)})):f.postHTTP(p.baseURL+"/oauthCallBack/authenticate",b).success((function(e,o,t,n){U.raiseEvent({name:"LOGIN_FACEBOOK_SUCCESS"});var s=t("new-user"),i=p.frontEndURL;if(i.indexOf("#")>=0&&(i=i.replace("#","")),s){var a=t("new-user-json");a=JSON.parse(t("new-user-json"));C.setFacebookUserData(a,r.provider),g.search({});var c="/patientSignup/facebook/"+p.authProvider[r.provider];r.actionFlow?g.url(c+"?actionFlow="+r.actionFlow):g.url(c)}if(e.token){l.redirectModelAfterFacebookLogin(e)}}))}null!=r.saml&&null!=r.accessTokenID&&(d.getUserCookie("x-auth-token")||((b={}).saml=r.saml,b.accessTokenID=r.accessTokenID,f.postHTTP(p.baseURL+"/samlAuth/authenticate",b).success((function(e,o,t,n){var s=t("new-user"),i=p.frontEndURL;if(i.indexOf("#")>=0&&(i=i.replace("#","")),s){var a=t("new-user-json");return C.setSamlUserData(JSON.parse(a),r.saml),g.search({}),void g.path("/patientSignup/saml/"+r.saml)}if(e.token){d.fetchUserAgreements(e.token,v.get("langKey"),(function(){if(null!=d.getUserCookie("userAgreements").userAgreements&&(d.getUserCookie("userAgreements").userAgreements.length>0||1==d.getUserCookie("incorrectUserAgreements")))return d.setUserCookie("agreementType",h("findAgreementType")(e.roles)),y.setAuthToken(e.token),g.path("/agreement"),d.setUserCookie("preAgreementLogin",e.username),!1;d.setUserCookie("x-auth-token",e.token),d.getConfigList(e.token),d.getVitalConfig(e.token),d.getUserDetails(!0)}))}})).error((function(e,o,t,r){n.showSpinner=!1,424==o?(g.search("saml",null),g.search("accessTokenID",null),A.error(h("translate")("login.samlDependencyNotExists"))):409==o&&(g.search("saml",null),g.search("accessTokenID",null),A.error(h("translate")("login.samlChildAccountAlreadyAttachedException")))}))));if(l.redirectModelAfterFacebookLogin=function(e){l.redirectForUserPreRequisite(e)},l.fetchSignupConfigs=function(){r.errorCode&&k(["login.identityExchangeApiErrors"]).then((function(){A.error(h("translate")("login.identityExchangeApiErrors."+r.errorCode))})),C.getSignUpConfig().success((function(e,o,t,r){l.configData=e,l.configData.passwordRegex=e.passwordRegex})).error((function(e,o,t,r){}))},l.redirectModel=function(e,o,t,r){d.fetchUserAgreements(e.token,v.get("langKey"),(function(){if(null!=d.getUserCookie("userAgreements").userAgreements&&d.getUserCookie("userAgreements").userAgreements.length>0||1==d.getUserCookie("incorrectUserAgreements"))return d.setUserCookie("agreementType",h("findAgreementType")(e.roles)),y.setAuthToken(e.token),o&&t?g.path("/agreement/?"+h("convertJSONToQueryString")({targetUrl:t,redirectFromCookie:r})):g.path("/agreement"),d.setUserCookie("preAgreementLogin",l.username),!1;if(e.firstLogin&&"ldap"!=v.get("loginType"))return y.setAuthToken(e.token),o&&t?g.path("/firstLoginChangePassword/?"+h("convertJSONToQueryString")({targetUrl:t,redirectFromCookie:r})):g.path("/firstLoginChangePassword"),!1;if(e.passwordExpired&&"ldap"!=v.get("loginType"))return y.setAuthToken(e.token),o&&t?g.path("/firstLoginChangePassword/?"+h("convertJSONToQueryString")({targetUrl:t,redirectFromCookie:r})):g.path("/firstLoginChangePassword"),!1;d.setUserCookie("x-auth-token",e.token),d.getConfigList(e.token),d.getVitalConfig(e.token),o&&t?(d.getUserDetails(!1),n.userDetailsPromise.promise.then((function(){var e=d.getUserCookie("user");if(e&&e.id){var o=d.getRedirectAfterLoginUrl(e.id);o?(d.removeRedirectAfterLoginUrl(),g.path(o)):r?d.redirectToAppointment(e.patientId):g.path(t)}}))):d.getUserDetails(!0)}))},l.postUserChecksAction=function(e){d.setUserCookie("x-auth-token",e.token),d.getConfigList(e.token),d.getVitalConfig(e.token),d.getUserDetails(!0)},l.getTFAContactName=function(){return h("translate")("twoFactorAuth.contact."+l.otpSentToDevice)},l.twoFactorAuthValidateToken=function(e){if(n.showSpinner=!0,null==l.otp||""==l.otp)return l.message=h("translate")("twoFactorAuth.otpBlankMessage"),n.showSpinner=!1,!1;n.loginType;var o=n.authProvider,s=(p.authProvider[o],p.baseURL+"/citadelAuth/validateTFAOTP"),i=v.get("username");l.username=i;var a=y.getAuthToken(),u={method:"POST",url:s,headers:{"x-auth-token":a},data:{username:i,otp:l.otp}};c(u).success((function(e,o,s,i){var c,u;if(n.showSpinner=!1,r.urlFilter&&(c=r.urlFilter,u=t.parseParams(r.urlFilter).targetUrl),!u){var g=d.getRedirectAfterLoginUrl(e.id);g&&g.length>0&&(u=g,c={})}e?e.token=a:e={token:a},m.remove("oTPSentToDevices"),l.redirectModel(e,c,u),n.hideAppointmentLinkFromHeader=!0})).error((function(e,o,t,r){if(n.showSpinner=!1,403==o){var s=h("translate")("login.accountBlockedMessage");l.showTFAError(s,!0)}else l.message=h("translate")("twoFactorAuth.invalidOTP"),l.successmessage=null}))},l.initCountDownTimer=function(){var e=(new Date).getTime()+1e3*p.serverConfig.resendOtpAfterTheseManySeconds;!function o(){var t=(new Date).getTime(),r=e-t,n=Math.floor(r%36e5/6e4).toString(),s=Math.floor(r%6e4/1e3).toString();n<10&&(n="0"+n),s<10&&(s="0"+s),l.countDownTimerMinutes=n,l.countDownTimerSeconds=s,r<=0?(clearTimeout(l.timeoutId),l.timeoutId=null,l.countDownTimerExpired=!0):l.timeoutId=setTimeout((function(){o(),l.$apply()}),1e3)}()},l.resendTFAOTP=function(e){this.otp="",this.TFAOTPForm.otp.$dirty=!1,n.showSpinner=!0;var o={method:"POST",url:p.baseURL+"/citadelAuth/resendTFAOTP",headers:{"x-auth-token":y.getAuthToken()}};c(o).success((function(e,o,t,r){l.setOTPSentToDevicesLabel(t("oTPSentToDevices")),m.remove("oTPSentToDevices"),n.showSpinner=!1,l.message=null,l.passwordErrorMessage=null,l.successmessage=h("translate")("twoFactorAuth.resentOTPMessage"),l.countDownTimerExpired=!1})).error((function(e,o,t,r){if(n.showSpinner=!1,401==o||500==o)n.message=h("translate")("login.sessionExpiredMessage"),d.removeAllCookies(p.logout.redirectUrl);else if(403==o){var s=h("translate")("login.accountBlockedMessage");l.showTFAError(s,!0)}else if(424==o){s=h("translate")("twoFactorAuth.userContactNotFoundForTFAError");l.showTFAError(s,!1)}else if(503==o){s=h("translate")("twoFactorAuth.failedDependencyError");l.showTFAError(s,!1)}}))},l.setOTPSentToDevicesLabel=function(e){try{if(null!=e){var o=null;e=JSON.parse(e),Object.keys(e).forEach((function(e){var t=null;"mobile"==e?t=h("translate")("twoFactorAuth.mobileLabel"):"email"==e&&(t=h("translate")("twoFactorAuth.emailLabel")),o=null==o?t:o+h("translate")("twoFactorAuth.andLabel")+t})),l.otpSentToDevice=o,m.set("oTPSentToDevices",o)}}catch(e){console.log(e)}},g.path().indexOf("/twoFactorAuth")>=0)try{l.message="",l.otpSentToDevice=m.get("oTPSentToDevices")}catch(e){console.log(e)}l.checkIfPhoneNumberEntered=function(e){l.showPhoneNumberError=!1,o("#"+e).val()||(l.showPhoneNumberError=!0)},l.setFormUntoched=function(e){e&&(e.$setPristine(),e.$setUntouched(),l.showPhoneNumberError=!1)},l.logIn=function(e,t){"NONCE"!==l.loginType&&g.search({}),l.setFormFieldsTouched(t),g.search({}),n.showSpinner=!0,l.message="",n.hideAppointmentLinkFromHeader=!1,n.loginType=l.loginType;var r={};if("USERNAME"==l.loginType){if(null==l.username||null==l.password||""==l.username||""==l.password)return l.message=h("translate")("login.usernameOrPasswordBlankMessage"),n.showSpinner=!1,!1;var s=l.username;1==p.useDefaultCountryCodeForLoginWithMobileNumber&&10==s.length&&1==/^\d+$/.test(s)&&(s=p.defaultCountryCode+s),r={username:s,password:l.password}}else if("EMAIL"==l.loginType){if(null==l.email||null==l.password||""==l.email||""==l.password)return l.message=h("translate")("login.emailOrPasswordBlankMessage"),n.showSpinner=!1,!1;r={email:l.email,password:l.password},U.raiseEvent({name:"LOGIN_EMAIL_ATTEMPT",data:{pageTitle:"login"}})}else if("MOBILE"==l.loginType){var i="",a="";l.checkIfPhoneNumberEntered("auth_mobile_input");var u=o("#auth_mobile_input");if(i=u.intlTelInput("getSelectedCountryData"),a=u.intlTelInput("getNumber"),console.log(a),i="+"+i.dialCode,null==(a=a.replace(i,""))||null==l.password||""==a||""==l.password)return l.message=h("translate")("login.mobileNoOrPasswordBlankMessage"),n.showSpinner=!1,!1;r={phoneNumber:a,countryCode:i,password:l.password}}else"CPS"==l.loginType?r={cpsToken:l.cpsToken}:"NONCE"==l.loginType&&(r={nonceToken:l.nonceToken});var d="";if(null!=e&&"ldap"==e.loginType){var f=p.authProvider[e.authProvider];v.set("loginType",e.loginType),v.set("authProvider",e.authProvider),d=p.baseURL+"/api/login?authProvider=ldap_"+f}else d=p.baseURL+"/api/login";c({method:"POST",url:d,headers:{"api-info":"V2|appVerson|deviceBrand|deviceModel|deviceScreenResolution|deviceOs|deviceOsVersion|deviceNetworkProvider|deviceNetworkType"},data:r}).success(l.handleSuccessfulLogin).error(l.handleUnsuccessfulLogin)},l.handleSuccessfulLogin=function(e,o,s,c){g.search({}),U.raiseEvent({name:"LOGIN_SUCCESS",data:{userID:e.id}});var u=s("new-user"),h=s("isOTPSent");l.username=e.username,n.configWithLoginWSPromise=i.defer();var f,T,k=s("authentication_mechanism");k&&(n.loginType=k,d.setUserCookie("loginType",k),u&&(v.set("loginType",k),v.set("authProvider",k+"Server1"))),n.showSpinner=!1;if(r.urlFilter&&(f=r.urlFilter,T=t.parseParams(r.urlFilter).targetUrl),m.set("expires_in",e.expires_in),e.token){if(!w.status()&&e.token&&w.createWebSocketConnectionWithToken(e.token),1==n.openAuthenticationContainer)return m.set("x-auth-token",e.token),l.closeCustomModal(),d.getUserDetails(!1),d.getConfigList(e.token),d.getVitalConfig(e.token),void n.userDetailsPromise.promise.then((function(){l.$emit("saveAppointmentObj",{})}));if("NONCE"==l.loginType)return m.set("x-auth-token",e.token),d.getUserDetails(!1),d.getConfigList(e.token),d.getVitalConfig(e.token),void n.userDetailsPromise.promise.then((function(){console.log("integratedDashboardFlag = "+r.integratedDashboard),r.integratedDashboard&&(d.setUserCookie("integratedDashboardFlag",!0),n.integratedDashboardFlag=!0),"true"==r.hidePatientBanner&&d.setUserCookie("hidePatientBanner",!0),F.nonceRedirectAfterLogin()}));if(h)v.set("username",l.username),l.setOTPSentToDevicesLabel(s("oTPSentToDevices")),y.setAuthToken(e.token),a.location.href=p.twoFactorAuth;else{n.hideAppointmentLinkFromHeader=!0;var P=d.getRedirectAfterLoginUrl(e.id);P&&P.length>0&&(T=P,f={},!0),l.redirectModel(e,f,T)}}else if(u){var A=JSON.parse(s("new-user-json"));C.setLdapUserData(A,n.authProvider),g.search({}),g.path("/patientSignup/"+l.loginWith+"/"+p.authProvider[n.authProvider])}},l.handleUnsuccessfulLogin=function(o,t,r,s){var i=o&&o.errors?o.errors[0]:{};n.showSpinner=!1,U.raiseEvent({name:"LOGIN_ERROR",data:{}}),400!=t&&401!=t&&560!=t&&null!=t||(l.message=function(){if("MOBILE"===l.loginType)return h("translate")("login.mobileAuthenticationFailureMessage");if("EMAIL"===l.loginType)return h("translate")("login.emailAuthenticationFailureMessage");if("USERNAME"===l.loginType)return h("translate")("login.userNameAuthenticationFailureMessage");if(l.loginType===p.signInOptionAllowed.SignInFlow.withOTP)return h("translate")("login.userOTPAuthenticationFailureMessage")}());var a=r?r("incorrectPasswordRetries"):0,c=p.numberOfRetriesToEnableCaptcha;if(parseInt(a)>parseInt(c)&&(l.retiresMoreThanThree=!0,l.retiresMoreThanThree&&(l.retiresMoreThanThree=!0,l.setResponse(null),n.showSpinner=!1,e.reload(l.widgetId))),500==t&&(l.message=h("translate")("login.serverErrorWhileAuthentication")),502==t&&(l.message=h("translate")("login.badGatewayError")),401==t&&"UV08"==i.code)l.message=h("translate")("login.accountBlockedMessage");else if(401==t&&"UV23"==i.code)l.message=h("translate")("login.LDAPAccountBlockedMessage");else if(406==t)l.message=h("translate")("licenseMessages.authenticationFailureMessage");else if(403==t||425==t)l.message=h("translate")("login.authenticationFailureMessageOnMaximumRetries");else if(460==t||427==t)l.message=h("translate")("login.disabledMergedUserMessage");else if(423==t)l.message=h("translate")("login.multipleActiveUsers");else if(426==t)l.message=h("translate")("login.pendingUserFailureMessage");else if(424==t){var u=h("translate")("twoFactorAuth.userContactNotFoundForTFAError");l.showTFAError(u,!1)}else if(503==t){u=h("translate")("twoFactorAuth.failedDependencyError");l.showTFAError(u,!1)}},l.logInViaCPS=function(e){l.cpsToken=r.cpsToken,l.cpsToken&&(l.loginType="CPS",l.logIn())},l.logInViaNonce=function(e){if(r.nonceToken)l.loginType="NONCE",l.nonceToken=r.nonceToken,l.logIn();else if(r.nonceTokenForLoggedInUser){F.loginViaNonce(r.nonceTokenForLoggedInUser).then((function(e){e.status?F.nonceRedirectAfterLogin():g.path("/notAccessible")}))}};l.showTFAError=function(e,o){var t={headerText:h("translate")("twoFactorAuth.twoFactorErrorHeader"),bodyText:e,showCancelButton:!1};P.showModal({},t).then((function(e){o&&g.path("/auth")}))},l.switchToOtherAuth=function(e){null!=e&&(n.loginType=e.loginType,n.authProvider=e.authProvider),g.path("/otherAuth")},l.checkParams=function(){null!=n.loginType&&n.loginType||g.path("/auth")},l.loginWithSAML=function(e){null!=e&&(n.loginType=e.loginType,n.authProvider=e.authProvider),f.postHTTP(p.baseURL+"/samlAuth/createSamlRequest?saml="+p.authProvider[n.authProvider],{}).success((function(e,o,t,r){n.SAMLRequest=e.SAMLRequest,n.serverUrl=e.serverUrl,v.set("loginType","saml"),v.set("authProvider",n.authProvider);s.open({templateUrl:"components/login/redirectModal.html",controller:"SamlModalCtrl",scope:l,size:"md",resolve:{}})}))},l.changePasswordUsingIdx=function(){s.open({templateUrl:"components/login/changePasswordModal.html",controller:"changePasswordRedirectButtonCtrl",scope:l,size:"sm",resolve:{}})},l.verifyDocumentUsingIdx=function(){s.open({templateUrl:"components/login/verifyDocumentModal.html",controller:"changePasswordRedirectButtonCtrl",scope:l,size:"sm",resolve:{}})},l.updateProfileUsingIdx=function(e){f.postHTTP(p.baseURL+"/oauth2Helper/updateProfile?provider=idx&source=web&event="+e,{},!0).success((function(e,o,t,r){e.redirect_to?(d.removeAllCookies(!1),a.location.href=e.redirect_to):A.error(h("translate")("UserProfile.updateApiErrorText"))})).error((function(e,o,t,r){A.error(h("translate")("UserProfile.updateApiErrorText"))}))},l.deactivateUserConfirmPopup=function(){l.deactivateReasonList=p.serverConfig.deactivateReasonList;s.open({templateUrl:"components/login/deactivatePopupModal.html",controller:"deactivateRedirectButtonCtrl",scope:l,size:"sm",resolve:{}})},l.deactivateUser=function(e){f.postHTTP(p.baseURL+"/moUser/deactivateUser",{deactivateReason:e},!0,{name:"api-info",value:"V1|appVerson|deviceBrand|deviceModel|deviceScreenResolution|deviceOs|deviceOsVersion|deviceNetworkProvider|deviceNetworkType"}).success((function(e,o,t,r){A.success(h("translate")("UserProfile.deactivateApiSuccessText")),T.logout(),w.logout(),d.removeAllCookies(!0)})).error((function(e,o,t,r){A.error(h("translate")("UserProfile.deactivateApiErrorText"))}))},l.logout=function(){n.hideAppointmentLinkFromHeader=!1;var e=m.get("report-view-otp"),o={};e&&(o["report-view-otp"]=e);var t=p.baseURL+"/api/logout",r=n.user.authProvider,s=p.logout.externalLogoutProviderList;r&&s&&s.indexOf(r)>-1&&(t=p.baseURL+"/oauth2/logout?provider="+r+"&source=web"),f.postHTTP(t,{},!1,o).success((function(e,o,t,r){l.$$phase||l.$apply(),n.loginType=void 0,n.userDetailsPromise=void 0,l.message="",T.logout(),w.logout(),e.redirect_to?(d.removeAllCookies(!1),a.location.href=e.redirect_to):d.removeAllCookies(!0),E.clearAll()}))},l.changePassword=function(){var e=l.detectDeviceType();f.postHTTP(p.baseURL+"/user/changePassword",{oldPassword:l.oldPassword,newPassword:l.newPassword,deviceType:e}).success((function(o,t,r,n){l.$$phase||l.$apply(),console.log(o.appRedirectUrl),"ios"==e||"android"==e?g.path(o.appRedirectUrl):l.redirectToDefault()})).error((function(e,o,t,r){422==o&&(l.message=h("translate")("changePassword.errorText."+e.status)),423==o&&(l.message=h("translate")("changePassword.errorText."+e.status))}))},l.removeConsentPopup=function(){s.open({templateUrl:"components/login/revokeConsentPopupModal.html",controller:"deactivateRedirectButtonCtrl",scope:l,size:"sm",resolve:{}})},l.removeConsentFromIdx=function(){f.getHTTP(p.baseURL+"/oauth2Helper/revokeConsent?source=web").success((function(e,o,t,r){e.redirect_to?(d.removeAllCookies(!1),a.location.href=e.redirect_to):A.error(h("translate")("UserProfile.updateApiErrorText"))})).error((function(e,o,t,r){A.error(h("translate")("UserProfile.updateApiErrorText"))}))},l.detectDeviceType=function(){var e=navigator.userAgent||navigator.vendor||window.opera;return e.match(/iPad/i)||e.match(/iPhone/i)||e.match(/iPod/i)?"ios":e.match(/Android/i)?"android":"web"},l.passwordIsStrongEnough=!0,l.checkForPasswordStrength=function(e){Math.round(e/33)>=parseInt(p.passwordStrengthLevel)?l.passwordIsStrongEnough=!0:l.passwordIsStrongEnough=!1},l.checkNumber=function(e){e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode<=105||13!=e.keyCode&&46!=e.keyCode&&8!=e.keyCode&&37!=e.keyCode&&39!=e.keyCode&&9!=e.keyCode&&e.preventDefault()},l.forgotPassword=function(){var e=l.detectDeviceType();l.message="",null==l.username&&(l.username=n.username),f.postHTTP(p.baseURL+"/user/forgotPassword",{username:l.username,baseUrl:p.frontEndURL}).success((function(o,t,r,s){n.username=l.username,1==o.useResetPasswordPinFlow?1==o.otpSent?(A.success(h("translate")("forgotPassword.otpSuccessMessage")),g.path("/resetPinFlow")):A.error(h("translate")("forgotPassword.otpFailureMessage")):(alert(h("translate")("forgotPassword.successMessage")),"ios"==e||"android"==e?a.location.href=p.androidAppUrl:g.path(p.logout.redirectUrl))})).error((function(e,o,t,r){console.log(o),(404==o||422==o||460==o||4041==o&&"461"==e.status||(o=405))&&(l.message=h("translate")("forgotPassword.errorText."+e.status))}))},l.resetPasswordWithPin=function(){var e=l.detectDeviceType(),o=n.username;f.postHTTP(p.baseURL+"/user/updatePasswordWithPin",{username:o,otp:l.oneTimePassword,newPassword:l.newPassword,deviceType:e}).success((function(o,t,r,s){l.$$phase||l.$apply(),n.username="",A.success(h("translate")("resetPassword.successMessage")),"ios"==e||"android"==e?g.path(o.appRedirectUrl):l.redirectToDefault()})).error((function(e,o,t,r){422==o&&(l.message=h("translate")("changePassword.errorText."+e.status)),404==o&&"ONF"==e.status&&(l.message=h("translate")("forgotPassword.otpValidationFailure")),404==o&&"OPE404"==e.status&&(l.message=h("translate")("forgotPassword.otpValidationExpire")),400==o&&(A.error(h("translate")("changePassword.errorText."+e.status)),l.redirectToDefault()),423==o&&(l.message=h("translate")("changePassword.errorText."+e.status)),A.error(l.message)}))},l.checkUsernameExistance=function(){null==n.username&&l.redirectToDefault()},l.redirectToDefault=function(){g.path(d.getUserCookie("defaultMenu"))},l.redirectForUserPreRequisite=function(e){if("ERE404"===e.requiredPreequisite)return g.search({}),y.setAuthToken(e.token),g.path("/recoveryViaEmail"),!1;d.fetchUserAgreements(e.token,v.get("langKey")).success((function(){if(null!=d.getUserCookie("userAgreements").userAgreements&&(d.getUserCookie("userAgreements").userAgreements.length>0||1==d.getUserCookie("incorrectUserAgreements")))return d.setUserCookie("agreementType",h("findAgreementType")(e.roles)),g.search({}),y.setAuthToken(e.token),g.path("/agreement"),d.setUserCookie("preAgreementLogin",e.username),!1;d.setUserCookie("x-auth-token",e.token),d.getConfigList(e.token),d.getVitalConfig(e.token),d.getUserDetails(!0)})).error((function(){}))},l.submitRecoveryEmailUpdate=function(e){l.disableForm=!0;var o=y.getAuthToken();n.showSpinner=!0,d.updateRecoveryEmail(e,o).success((function(e){n.showSpinner=!1,e.username?l.redirectForUserPreRequisite(e):A.error(h("translate")("recoveryEmail.otpMisMatch")),l.disableForm=!1})).error((function(o){l.disableForm=!1,A.error(h("translate")("recoveryEmail.updateDetailError")),console.log(e)}))},l.sendOtpForEmailRecovery=function(e){return C.sendOneTimePassword(e).then((function(e){var o=e.data;o&&o.success?(A.success(h("translate")("patientSignUp.emailVerification.optSentSuccess")),l.recoveryOtpSent=!0):(A.error(h("translate")("patientSignUp.emailVerification.optSentError")),l.recoveryOtpSent=!1)}),(function(e){A.error(h("translate")("patientSignUp.emailVerification.optSentError")),l.recoveryOtpSent=!1}))},l.showCPSErrorPopUp=function(){s.open({templateUrl:"components/login/cpsPopUp.html",controller:"CPSController",scope:l,size:"sm",resolve:{}}).result.then((function(){g.path({})}),(function(){g.path({})}))},l.showAdfsLoginErrorPopUp=function(){s.open({templateUrl:"components/login/adfsPopUp.html",controller:"LDAPController",scope:l,size:"sm",resolve:{}}).result.then((function(){g.path({})}),(function(){g.path({})}))},l.showCPSError=function(){!l.errorParam||-1===l.errorParam.indexOf("userError")&&-1===l.errorParam.indexOf("certificateError")||l.showCPSErrorPopUp()},l.showAdfsLoginError=function(){l.errorParam&&-1!==l.errorParam.indexOf("adfsError")&&l.showAdfsLoginErrorPopUp()}}]).controller("CPSController",["$scope","$location","$modalInstance","userService","utilityService","ConfigurationHolder","notificationService","$filter",function(e,o,t,r,n,s,i,a){e.ok=function(){t.close()}}]).controller("LDAPController",["$scope","$location","$modalInstance","userService","utilityService","ConfigurationHolder","notificationService","$filter",function(e,o,t,r,n,s,i,a){e.ok=function(){t.close()}}]).controller("ForgotPasswordCtrl",["ConfigurationHolder","utilityService","$rootScope","notificationService","$scope","$routeParams","$location","$filter","$window",function(e,o,t,r,n,s,i,a,l){n.verificationCode=s.code,n.passwordIsStrongEnough=!0,n.checkForPasswordStrength=function(o){Math.round(o/33)>=parseInt(e.passwordStrengthLevel)?n.passwordIsStrongEnough=!0:n.passwordIsStrongEnough=!1},n.resetPassword=function(){n.detectDeviceType();o.postHTTP(e.baseURL+"/user/resetPassword",{verificationCode:s.code,newPassword:n.newPassword}).success((function(o,t,n,s){r.success(a("translate")("resetPassword.successMessage")),i.path(e.logout.redirectUrl)})).error((function(e,o,t,r){423!=o&&422!=o&&404!=o||(n.message=a("translate")("resetPassword.errorText."+e.status))}))},n.redirectAfterChangedPassInMobile=function(){l.location.href=e.androidAppUrl},n.detectDeviceType=function(){var e=navigator.userAgent||navigator.vendor||window.opera;return e.match(/iPad/i)||e.match(/iPhone/i)||e.match(/iPod/i)?"ios":e.match(/Android/i)?"android":"web"}}]).controller("FirstLoginAndPasswordExpiredCtrl",["userService","ConfigurationHolder","$q","$http","utilityService","$rootScope","$scope","$routeParams","$location","$filter","tokenService","eventWebSocketService","localStorageService",function(e,o,r,n,s,i,a,l,c,u,g,d,p){var h,f;i.showSpinner=!1,a.token=g.getAuthToken();var m=!1;l.urlFilter&&(h=l.urlFilter,f=t.parseParams(l.urlFilter).targetUrl,m="true"==t.parseParams(l.urlFilter).redirectFromCookie||1==t.parseParams(l.urlFilter).redirectFromCookie),a.changePasswordOnFirstLogin=function(){i.showSpinner=!0;var t=r.defer(),s=o.baseURL+"/user/changePasswordOnFirstLogin",l=a.token,g={method:"POST",url:s,headers:{"x-auth-token":l},data:{oldPassword:a.oldPassword,newPassword:a.newPassword},timeout:t.promise};return n(g).success((function(o,t,r,n){a.$$phase||a.$apply(),i.showSpinner=!1,e.setUserCookie("x-auth-token",l),e.getConfigList(l),e.getVitalConfig(l),console.log(h),console.log(f),h&&f?(e.getUserDetails(!1),i.userDetailsPromise.promise.then((function(){var o=e.getUserCookie("user");if(o&&o.id){var t=e.getRedirectAfterLoginUrl(o.id);t?(e.removeRedirectAfterLoginUrl(),c.path(t)):m?e.redirectToAppointment(o.patientId):c.path(f)}}))):e.getUserDetails(!0);var s=p.get("x-auth-token");!d.status()&&s&&d.createWebSocketConnectionWithToken(s)})).error((function(t,r,n,s){i.showSpinner=!1,423!=r&&422!=r||(a.message=u("translate")("changePassword.errorText."+t.status)),400!=r&&401!=r||(i.hideAppointmentLinkFromHeader=!1,i["x-auth-token"]?i.message=u("translate")("login.sessionExpiredMessage"):i.message=u("translate")("login.authenticationFailureMessage"),e.removeAllCookies(o.logout.redirectUrl))}))}}]).controller("AgreementCtrl",["localStorageService","userService","ConfigurationHolder","$q","$http","utilityService","$rootScope","$scope","$routeParams","$location","$filter","tokenService","eventWebSocketService","customLocalStorageService",function(e,r,n,s,i,a,l,c,u,g,d,p,h,f){var m,v;c.token=p.getAuthToken();var T=!1;c.disableAcceptButton=!1,o(window).scroll((function(){console.log("window.innerHeight-------- "+window.innerHeight+" ------ window.pageYOffset "+window.pageYOffset+" -------- document.body.offsetHeight--------- "+document.body.offsetHeight),1==c.disableAcceptButton&&(window.innerHeight+window.pageYOffset+10>=document.body.offsetHeight?c.disableAcceptButton=!1:c.disableAcceptButton=!0,c.$apply())})),u.urlFilter&&(m=u.urlFilter,v=t.parseParams(u.urlFilter).targetUrl,T="true"===t.parseParams(u.urlFilter).redirectFromCookie||!0===t.parseParams(u.urlFilter).redirectFromCookie),c.acceptAgreementNewFlow=function(){l.showSpinner=!0,l.message="";var o=n.baseURL+"/moManageAgreements/setAgreementAsRead",t=p.getAuthToken(),s={method:"POST",url:o,headers:{"api-info":"V1|appVerson|deviceBrand|deviceModel|deviceScreenResolution|deviceOs|deviceOsVersion|deviceNetworkProvider|deviceNetworkType","x-auth-token":t},data:{readDate:d("calendarToServerDateFormat")(new Date),status:"ACCEPTED",agreementId:c.agreementId}};return i(s).success((function(o,n,s,i){l.showSpinner=!1,c.$$phase||c.$apply(),c.agreementIndex=c.agreementIndex+1,console.log("moving to agreement no: "+c.agreementIndex);var a=r.getUserCookie("userAgreements").userAgreements.length;c.agreementIndex<a?c.loadNextAgreementContent():(r.removeCookie("userAgreements"),function(){if(r.removeCookie("preAgreementLogin"),r.removeCookie("agreementType"),o.firstLogin&&"SELF_SIGN_UP_WEB"!=o.signUpSource&&"ldap"!=f.get("loginType")&&"saml"!=f.get("loginType"))return p.setAuthToken(t),m&&v?g.path("/firstLoginChangePassword/?"+d("convertJSONToQueryString")({targetUrl:v,redirectFromCookie:T})):g.path("/firstLoginChangePassword"),!1;if(o.passwordExpired&&"ldap"!=f.get("loginType")&&"saml"!=f.get("loginType"))return p.setAuthToken(t),m&&v?g.path("/firstLoginChangePassword/?"+d("convertJSONToQueryString")({targetUrl:v,redirectFromCookie:T})):g.path("/firstLoginChangePassword"),!1;r.setUserCookie("x-auth-token",t),r.getConfigList(t),r.getVitalConfig(t),m&&v?(r.getUserDetails(!1),l.userDetailsPromise.promise.then((function(){var e=r.getUserCookie("user");if(e&&e.id){var o=r.getRedirectAfterLoginUrl(e.id);o?(r.removeRedirectAfterLoginUrl(),g.path(o)):T?r.redirectToAppointment(e.patientId):g.path(v)}}))):r.getUserDetails(!0);var n=e.get("x-auth-token");!h.status()&&n&&h.createWebSocketConnectionWithToken(n)}(),console.log("all agreements accepted, continue to default menu item"))})).error((function(e,o,t,s){l.showSpinner=!1,l.hideAppointmentLinkFromHeader=!1,400!=o&&401!=o||(l.message=d("translate")("login.sessionExpiredMessage"),r.removeAllCookies(n.logout.redirectUrl))}))},c.declineAgreementNewFlow=function(){l.hideAppointmentLinkFromHeader=!1,l.message="";var e={method:"POST",url:n.baseURL+"/moManageAgreements/setAgreementAsRead",headers:{"api-info":"V1|appVerson|deviceBrand|deviceModel|deviceScreenResolution|deviceOs|deviceOsVersion|deviceNetworkProvider|deviceNetworkType","x-auth-token":p.getAuthToken()},data:{readDate:d("calendarToServerDateFormat")(new Date),status:"REJECTED",agreementId:c.agreementId}};return i(e).success((function(e,o,t,s){c.$$phase||c.$apply(),r.removeAllCookies(n.logout.redirectUrl)})).error((function(e,o,t,s){l.hideAppointmentLinkFromHeader=!1,400!=o&&401!=o||(l["x-auth-token"]?l.message=d("translate")("login.sessionExpiredMessage"):l.message=d("translate")("login.authenticationFailureMessage"),r.removeAllCookies(n.logout.redirectUrl))}))},r.getUserCookie("preAgreementLogin")||(l.hideAppointmentLinkFromHeader=!1,l.message=d("translate")("login.sessionExpiredMessage"),g.path(n.logout.redirectUrl)),r.getUserCookie("agreementType")&&(c.agreementType=r.getUserCookie("agreementType"))}]).controller("nonLoginCtrl",["$scope","$routeParams","$window","userService","utilityService","ConfigurationHolder","localStorageService","customLocalStorageService","$rootScope","$location",function(e,o,t,r,n,s,i,a,l,c){if(console.log("Physician without Login view"),null!=o.accessTokenID)if(r.getUserCookie("x-auth-token")&&r.getUserCookie("x-auth-token")!=o.accessTokenID)c.path("/auth");else{var u=o.accessTokenID,g=o.patientMRN;l.hidelogOutButton=!1;r.setUserCookie("x-auth-token",u),r.getConfigList(u),r.getVitalConfig(u),r.getUserDetails(!1),l.configPromise.promise.then((function(){l.hidelogOutButton=!0,c.path("showAllRecords/%3FpatientId="+g)}))}}]).controller("SamlModalCtrl",["$scope","$modalInstance",function(e,o){e.cancel=function(){o.close()}}]).controller("BreakTheGlassModalFullAccessCtrl",["$scope","$route","$modalInstance","userService","utilityService","ConfigurationHolder","notificationService","$filter","patientConsentService",function(e,o,t,r,n,s,i,a,l){e.cancel=function(){t.close()},e.addBreakTheGlassRole=function(){var r={patientId:e.patient_id,purpose:e.reason,comment:e.description},c=l.generateBtgConsentDo(r);n.postHTTP(s.baseURL+"/consent/saveConsentRequest",{consentList:c}).success((function(e,r,n,s){if(200==r&&e.saveList.length>0){a("translate")("breakTheGlass.successfullAccessMessage");o.reload()}t.close()})).error((function(e,o,t,r){i.error(a("translate")("breakTheGlass.accessFailureMessage"))}))}}]).controller("changePasswordRedirectButtonCtrl",["$scope","$route","$modalInstance",function(e,o,t){e.cancel=function(){t.close()}}]).controller("deactivateRedirectButtonCtrl",["$scope","$route","$modalInstance",function(e,o,t){e.cancel=function(){t.close()}}])}).call(this,t(1),t(1))}}]);